<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸€ì“°ê¸° - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
    <style>
      /* contenteditable ì—ë””í„° ìŠ¤íƒ€ì¼ */
      .rich-editor {
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        line-height: 1.6;
        color: #333;
        outline: none;
      }

      .rich-editor:focus {
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
      }

      /* placeholder ìŠ¤íƒ€ì¼ */
      .rich-editor:empty:before {
        content: attr(data-placeholder);
        color: #999;
        cursor: text;
      }

      /* ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ */
      .image-wrapper {
        position: relative;
        display: inline-block;
        margin: 10px 0;
        max-width: 100%;
        min-width: 100px;
      }

      /* ì—ë””í„° ë‚´ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
      .rich-editor img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: block;
        transition: box-shadow 0.2s;
      }

      .rich-editor img:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      /* ì´ë¯¸ì§€ ì„ íƒ ì‹œ */
      .image-wrapper.selected {
        outline: 3px solid #2196f3;
        outline-offset: 2px;
      }

      .image-wrapper.selected img {
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
      }

      /* ì‚­ì œ ë²„íŠ¼ */
      .image-delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 10;
      }

      .image-wrapper:hover .image-delete-btn,
      .image-wrapper.selected .image-delete-btn {
        opacity: 1;
      }

      .image-delete-btn:hover {
        background: #d32f2f;
        transform: scale(1.1);
      }

      /* ë¦¬ì‚¬ì´ì¦ˆ ì˜ì—­ (ì˜¤ë¥¸ìª½ í•˜ë‹¨ ëª¨ì„œë¦¬) */
      .image-wrapper::after {
        content: "";
        position: absolute;
        bottom: 0;
        right: 0;
        width: 30px;
        height: 30px;
        cursor: nwse-resize;
        z-index: 5;
      }

      /* ë¦¬ì‚¬ì´ì§• ì¤‘ */
      .image-wrapper.resizing {
        outline: 3px dashed #2196f3;
      }

      .image-wrapper.resizing img {
        pointer-events: none;
        user-select: none;
      }

      /* ì—ë””í„° íˆ´ë°” */
      .editor-toolbar {
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="write-container">
          <h2 id="pageTitle">ê²Œì‹œê¸€ ì‘ì„±</h2>
          <form id="writeForm" class="write-form">
            <div class="form-group">
              <label for="postTitle"
                >ì œëª© <span class="required">*</span></label
              >
              <input
                type="text"
                id="postTitle"
                required
                placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                maxlength="100"
              />
              <span class="helper-text">* ìµœëŒ€ 100ì</span>
              <span class="error-text" id="titleError"></span>
            </div>
            <div class="form-group">
              <label for="postContent"
                >ë‚´ìš© <span class="required">*</span></label
              >
              <div class="content-editor-wrapper">
                <div
                  id="postContent"
                  class="rich-editor"
                  contenteditable="true"
                  data-placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ì‚½ì…í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”."
                ></div>
                <div class="editor-toolbar">
                  <button
                    type="button"
                    class="btn btn-secondary btn-sm"
                    onclick="triggerImageUpload()"
                  >
                    ğŸ“· ì´ë¯¸ì§€ ì‚½ì…
                  </button>
                  <input
                    type="file"
                    id="imageInput"
                    accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                    multiple
                    style="display: none"
                    onchange="handleImageSelection(event)"
                  />
                  <small style="color: #666; margin-left: 1rem">
                    ì´ë¯¸ì§€ëŠ” ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…ë©ë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ, ê° 5MB)
                  </small>
                </div>
              </div>
              <span class="error-text" id="contentError"></span>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goBack()"
              >
                ì·¨ì†Œ
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                ë“±ë¡
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
    <!-- ìˆœì„œ ì¤‘ìš”: í´ë˜ìŠ¤ ì •ì˜ â†’ ì´ˆê¸°í™” -->
    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <!-- âœ… ë§ˆì§€ë§‰ì— ì´ˆê¸°í™” -->
    <script src="/js/initService.js"></script>
    <script>
      let editMode = false;
      let editPostId = null;
      let originalPost = null;
      let pendingImageFiles = [];
      let imageCounter = 0;
      let blobUrls = new Set(); // âœ… Blob URL ì¶”ì 
      let allowNavigation = false; // âœ… ë„¤ë¹„ê²Œì´ì…˜ í—ˆìš© í”Œë˜ê·¸

      document.addEventListener("DOMContentLoaded", async () => {
        // âœ… UI ì—…ë°ì´íŠ¸
        authManager.updateUI();

        // âœ… ë¡œê·¸ì¸ í™•ì¸ ê°œì„ 
        if (!authManager.isLoggedIn()) {
          showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          allowNavigation = true; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ í—ˆìš©
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        editPostId = urlParams.get("id");

        if (editPostId) {
          editMode = true;
          document.getElementById("pageTitle").textContent = "ê²Œì‹œê¸€ ìˆ˜ì •";
          document.getElementById("submitBtn").textContent = "ìˆ˜ì •";
          await loadPostForEdit(editPostId);
        }

        setupForm();
        setupEditorEvents();
        setupValidation();
      });

      // âœ… ìœ íš¨ì„± ê²€ì‚¬ ì„¤ì •
      function setupValidation() {
        const titleInput = document.getElementById("postTitle");

        titleInput.addEventListener("blur", validateTitle);
        titleInput.addEventListener("input", () =>
          clearFieldError(titleInput, "titleError")
        );
      }

      // âœ… í•„ë“œ ì—ëŸ¬ í‘œì‹œ
      function showFieldError(input, errorId, message) {
        input.classList.add("error");
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add("show");
        }
      }

      // âœ… í•„ë“œ ì—ëŸ¬ ì œê±°
      function clearFieldError(input, errorId) {
        input.classList.remove("error");
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
          errorElement.textContent = "";
          errorElement.classList.remove("show");
        }
      }

      // âœ… ì œëª© ìœ íš¨ì„± ê²€ì‚¬
      function validateTitle() {
        const titleInput = document.getElementById("postTitle");
        const title = titleInput.value.trim();

        clearFieldError(titleInput, "titleError");

        if (title.length === 0) {
          showFieldError(titleInput, "titleError", "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return false;
        }

        if (title.length > 100) {
          showFieldError(
            titleInput,
            "titleError",
            "ì œëª©ì€ 100ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."
          );
          return false;
        }

        return true;
      }

      // âœ… ë‚´ìš© ìœ íš¨ì„± ê²€ì‚¬
      function validateContent() {
        const editor = document.getElementById("postContent");
        const content = getEditorContent();

        if (!content || content.trim().length === 0) {
          showError("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return false;
        }

        return true;
      }

      async function loadPostForEdit(postId) {
        try {
          console.log("ê²Œì‹œê¸€ ë¡œë“œ ì‹œë„:", postId);

          const post = await postService.getPost(postId);
          console.log("ê²Œì‹œê¸€ ë¡œë“œ ì„±ê³µ:", post);

          originalPost = post;

          // âœ… authManager ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½
          const currentUser = authManager.getCurrentUser();
          console.log("í˜„ì¬ ì‚¬ìš©ì:", currentUser);

          if (!currentUser) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            allowNavigation = true;
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
            return;
          }

          const isAuthor =
            currentUser.userId === post.user.userId ||
            currentUser.nickname === post.user.nickname;

          console.log("ì‘ì„±ì í™•ì¸:", {
            isAuthor,
            currentUserId: currentUser.userId,
            postUserId: post.user.userId,
            currentNickname: currentUser.nickname,
            postNickname: post.user.nickname,
          });

          if (!isAuthor) {
            showError("ê²Œì‹œê¸€ ì‘ì„±ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            allowNavigation = true;
            setTimeout(() => {
              window.location.href = `/posts/${postId}`;
            }, 1500);
            return;
          }

          document.getElementById("postTitle").value = post.title;

          const editor = document.getElementById("postContent");
          editor.innerHTML = convertMarkdownToHtml(post.body || "");

          addDeleteButtonsToExistingImages();
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:", error);

          allowNavigation = true;

          // âœ… ì—ëŸ¬ ì²˜ë¦¬
          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } else if (error.status === 403) {
            showError("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/posts";
            }, 1500);
          } else if (error.status === 404) {
            showError("ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/posts";
            }, 1500);
          } else {
            showError("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/posts";
            }, 1500);
          }
        }
      }

      function addDeleteButtonsToExistingImages() {
        const editor = document.getElementById("postContent");

        const wrappers = editor.querySelectorAll(".image-wrapper");
        wrappers.forEach((wrapper) => {
          if (wrapper.querySelector(".image-delete-btn")) {
            return;
          }

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "image-delete-btn";
          deleteBtn.textContent = "Ã—";
          deleteBtn.type = "button";
          deleteBtn.setAttribute("contenteditable", "false");

          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (confirm("ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              wrapper.remove();
            }
          });

          wrapper.insertBefore(deleteBtn, wrapper.firstChild);
          wrapper.setAttribute("contenteditable", "false");
        });

        const standaloneImages = editor.querySelectorAll(
          "img:not(.image-wrapper img)"
        );
        standaloneImages.forEach((img) => {
          const src = img.getAttribute("src");
          const alt = img.getAttribute("alt") || "ì´ë¯¸ì§€";

          const existingWidth = img.style.width || img.getAttribute("width");

          const wrapper = document.createElement("div");
          wrapper.className = "image-wrapper";
          wrapper.setAttribute("contenteditable", "false");

          if (existingWidth) {
            wrapper.style.width = existingWidth.includes("px")
              ? existingWidth
              : existingWidth + "px";
          }

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "image-delete-btn";
          deleteBtn.textContent = "Ã—";
          deleteBtn.type = "button";
          deleteBtn.setAttribute("contenteditable", "false");
          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (confirm("ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              wrapper.remove();
            }
          });

          const newImg = document.createElement("img");
          newImg.src = src;
          newImg.alt = alt;
          newImg.style.width = "100%";
          newImg.style.height = "auto";

          wrapper.appendChild(deleteBtn);
          wrapper.appendChild(newImg);

          img.parentNode.replaceChild(wrapper, img);
        });
      }

      function convertMarkdownToHtml(content) {
        if (!content) return "";

        if (content.includes("<img") || content.includes("<div")) {
          return content;
        }

        let html = content.replace(
          /!\[(.*?)\]\((.*?)\)/g,
          (match, alt, url) => {
            return createImageWrapperHtml(url, alt, url);
          }
        );
        html = html.replace(/\n/g, "<br>");
        return html;
      }

      function createImageWrapperHtml(src, alt, dataUrl) {
        return `<div class="image-wrapper" contenteditable="false">
                <img src="${src}" alt="${escapeHtml(
          alt
        )}" data-image-url="${dataUrl}">
                <button class="image-delete-btn" onclick="removeImage(this)" title="ì´ë¯¸ì§€ ì‚­ì œ">Ã—</button>
            </div>`;
      }

      function setupEditorEvents() {
        const editor = document.getElementById("postContent");

        editor.addEventListener("keydown", (e) => {
          if (e.key === "Delete" || e.key === "Backspace") {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
              const range = selection.getRangeAt(0);
              const selectedElement = range.commonAncestorContainer;

              let imageWrapper = null;
              if (
                selectedElement.nodeType === Node.ELEMENT_NODE &&
                selectedElement.classList.contains("image-wrapper")
              ) {
                imageWrapper = selectedElement;
              } else if (
                selectedElement.parentElement &&
                selectedElement.parentElement.classList.contains(
                  "image-wrapper"
                )
              ) {
                imageWrapper = selectedElement.parentElement;
              }

              if (imageWrapper) {
                e.preventDefault();
                removeImageWrapper(imageWrapper);
              }
            }
          }
        });

        editor.addEventListener("mousedown", (e) => {
          const target = e.target;
          const wrapper = target.closest(".image-wrapper");

          if (wrapper) {
            const rect = wrapper.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const offsetY = e.clientY - rect.top;

            if (offsetX >= rect.width - 30 && offsetY >= rect.height - 30) {
              e.preventDefault();
              startResize(e, wrapper);
            }
          }
        });
      }

      function triggerImageUpload() {
        document.getElementById("imageInput").click();
      }

      function handleImageSelection(event) {
        const files = Array.from(event.target.files);
        const editor = document.getElementById("postContent");

        if (pendingImageFiles.length + files.length > 5) {
          showError("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          event.target.value = "";
          return;
        }

        for (const file of files) {
          if (!validateImageFile(file)) {
            continue;
          }

          const tempId = `TEMP_IMAGE_${imageCounter++}`;
          pendingImageFiles.push({ id: tempId, file: file });

          // âœ… Blob URL ìƒì„± ë° ì¶”ì 
          const tempUrl = URL.createObjectURL(file);
          blobUrls.add(tempUrl);

          const wrapper = document.createElement("div");
          wrapper.className = "image-wrapper";
          wrapper.setAttribute("contenteditable", "false");

          const img = document.createElement("img");
          img.src = tempUrl;
          img.alt = file.name;
          img.dataset.tempId = tempId;

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "image-delete-btn";
          deleteBtn.innerHTML = "Ã—";
          deleteBtn.title = "ì´ë¯¸ì§€ ì‚­ì œ";
          deleteBtn.onclick = function () {
            removeImage(this);
          };

          wrapper.appendChild(img);
          wrapper.appendChild(deleteBtn);

          insertImageAtCursor(wrapper);

          const br = document.createElement("br");
          insertImageAtCursor(br);
        }

        event.target.value = "";
      }

      function removeImage(button) {
        const wrapper = button.parentElement;
        removeImageWrapper(wrapper);
      }

      function removeImageWrapper(wrapper) {
        const img = wrapper.querySelector("img");
        const tempId = img.dataset.tempId;
        const blobUrl = img.src;

        // âœ… Blob URL í•´ì œ
        if (blobUrl && blobUrl.startsWith("blob:")) {
          URL.revokeObjectURL(blobUrl);
          blobUrls.delete(blobUrl);
        }

        if (tempId) {
          const index = pendingImageFiles.findIndex(
            (item) => item.id === tempId
          );
          if (index !== -1) {
            pendingImageFiles.splice(index, 1);
            console.log(
              `ì´ë¯¸ì§€ ì‚­ì œë¨: ${tempId}, ë‚¨ì€ ì´ë¯¸ì§€: ${pendingImageFiles.length}ê°œ`
            );
          }
        }

        wrapper.remove();
      }

      function insertImageAtCursor(element) {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(element);

          range.setStartAfter(element);
          range.setEndAfter(element);
          selection.removeAllRanges();
          selection.addRange(range);
        } else {
          document.getElementById("postContent").appendChild(element);
        }
      }

      function validateImageFile(file) {
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];

        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return false;
        }

        if (file.size > 5 * 1024 * 1024) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          return false;
        }

        return true;
      }

      function getEditorContent() {
        const editor = document.getElementById("postContent");

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = editor.innerHTML;

        tempDiv
          .querySelectorAll(".image-delete-btn")
          .forEach((btn) => btn.remove());

        return tempDiv.innerHTML.trim();
      }

      async function uploadPendingImages() {
        if (pendingImageFiles.length === 0) {
          return [];
        }

        try {
          const files = pendingImageFiles.map((item) => item.file);
          const response = await fileUploadService.uploadImages(files);
          return response.urls;
        } catch (error) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
          throw new Error(error.message || "ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function replaceTemporaryIds(content, uploadedUrls) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = content;

        pendingImageFiles.forEach((item, index) => {
          const tempId = item.id;
          const actualUrl = uploadedUrls[index];

          const img = tempDiv.querySelector(`img[data-temp-id="${tempId}"]`);
          if (img) {
            img.src = actualUrl;
            img.removeAttribute("data-temp-id");
          }
        });

        return tempDiv.innerHTML;
      }

      function extractImageUrls(content) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = content;

        const urls = [];
        const images = tempDiv.querySelectorAll("img");

        images.forEach((img) => {
          const src = img.getAttribute("src");
          if (
            src &&
            !src.startsWith("TEMP_IMAGE_") &&
            !src.startsWith("blob:")
          ) {
            urls.push(src);
          }
        });

        return urls;
      }

      function setupForm() {
        const writeForm = document.getElementById("writeForm");
        writeForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          // âœ… ìœ íš¨ì„± ê²€ì‚¬
          if (!validateTitle() || !validateContent()) {
            return;
          }

          const title = document.getElementById("postTitle").value.trim();
          let body = getEditorContent();

          const submitBtn = document.getElementById("submitBtn");
          submitBtn.disabled = true;
          submitBtn.textContent = editMode ? "ìˆ˜ì • ì¤‘..." : "ë“±ë¡ ì¤‘...";

          try {
            let uploadedUrls = [];
            if (pendingImageFiles.length > 0) {
              submitBtn.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
              uploadedUrls = await uploadPendingImages();
              body = replaceTemporaryIds(body, uploadedUrls);
            }

            const imageUrls = extractImageUrls(body);

            console.log("ìµœì¢… body:", body);
            console.log("ìµœì¢… imageUrls:", imageUrls);

            submitBtn.textContent = editMode
              ? "ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘..."
              : "ê²Œì‹œê¸€ ë“±ë¡ ì¤‘...";

            if (editMode) {
              await postService.updatePost(editPostId, title, body, imageUrls);
              showSuccess("ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

              // âœ… Blob URL ì •ë¦¬
              cleanupBlobUrls();

              // âœ… ë„¤ë¹„ê²Œì´ì…˜ í—ˆìš©
              allowNavigation = true;

              setTimeout(() => {
                window.location.href = `/posts/${editPostId}`;
              }, 1000);
            } else {
              const response = await postService.createPost(
                title,
                body,
                imageUrls
              );
              showSuccess("ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");

              // âœ… Blob URL ì •ë¦¬
              cleanupBlobUrls();

              // âœ… ë„¤ë¹„ê²Œì´ì…˜ í—ˆìš©
              allowNavigation = true;

              setTimeout(() => {
                window.location.href = "/posts";
              }, 1000);
            }
          } catch (error) {
            console.error("ê²Œì‹œê¸€ ì²˜ë¦¬ ì‹¤íŒ¨:", error);

            // âœ… ì—ëŸ¬ ì²˜ë¦¬
            let errorMessage = "ê²Œì‹œê¸€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";

            if (error.status === 401) {
              errorMessage = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
            } else if (error.status === 403) {
              errorMessage = "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
            } else if (error.status === 400) {
              errorMessage = error.message || "ì…ë ¥ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            } else if (error.message) {
              errorMessage = error.message;
            }

            showError(errorMessage);

            submitBtn.disabled = false;
            submitBtn.textContent = editMode ? "ìˆ˜ì •" : "ë“±ë¡";
          }
        });
      }

      // âœ… Blob URL ì •ë¦¬
      function cleanupBlobUrls() {
        blobUrls.forEach((url) => {
          URL.revokeObjectURL(url);
        });
        blobUrls.clear();
        console.log("Blob URL ì •ë¦¬ ì™„ë£Œ");
      }

      function goBack() {
        const title = document.getElementById("postTitle").value.trim();
        const content = getEditorContent();

        // âœ… ë³€ê²½ì‚¬í•­ í™•ì¸
        if ((title || content) && !allowNavigation) {
          if (!confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
          }
        }

        // âœ… Blob URL ì •ë¦¬
        cleanupBlobUrls();

        // âœ… ë„¤ë¹„ê²Œì´ì…˜ í—ˆìš©
        allowNavigation = true;

        if (editMode && editPostId) {
          window.location.href = `/posts/${editPostId}`;
        } else {
          window.location.href = "/posts";
        }
      }

      // âœ… í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ Blob URL ì •ë¦¬ ë° ê²½ê³ 
      window.addEventListener("beforeunload", (e) => {
        // Blob URL ì •ë¦¬ëŠ” í•­ìƒ ìˆ˜í–‰
        cleanupBlobUrls();

        // ì‘ì„± ì™„ë£Œ í›„ì—ëŠ” ê²½ê³  í‘œì‹œ ì•ˆ í•¨
        if (allowNavigation) {
          return;
        }

        const title = document.getElementById("postTitle").value.trim();
        const content = getEditorContent();

        // ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ í™•ì¸
        if (title || content) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      // âœ… ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ë³€ìˆ˜
      let resizingWrapper = null;
      let resizeStartX = 0;
      let resizeStartWidth = 0;

      function startResize(event, wrapper) {
        event.preventDefault();
        event.stopPropagation();

        resizingWrapper = wrapper;
        resizingWrapper.classList.add("resizing");

        resizeStartX = event.clientX;
        resizeStartWidth = resizingWrapper.offsetWidth;

        document.addEventListener("mousemove", doResize);
        document.addEventListener("mouseup", stopResize);
      }

      function doResize(event) {
        if (!resizingWrapper) return;

        const deltaX = event.clientX - resizeStartX;
        const newWidth = resizeStartWidth + deltaX;

        const minWidth = 100;
        const maxWidth = resizingWrapper.parentElement.offsetWidth - 30;

        if (newWidth >= minWidth && newWidth <= maxWidth) {
          resizingWrapper.style.width = newWidth + "px";
        }
      }

      function stopResize() {
        if (resizingWrapper) {
          resizingWrapper.classList.remove("resizing");
          resizingWrapper = null;
        }

        document.removeEventListener("mousemove", doResize);
        document.removeEventListener("mouseup", stopResize);
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
