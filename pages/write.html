<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ì“°ê¸° - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* contenteditable ì—ë””í„° ìŠ¤íƒ€ì¼ */
        .rich-editor {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            outline: none;
        }

        .rich-editor:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        /* placeholder ìŠ¤íƒ€ì¼ */
        .rich-editor:empty:before {
            content: attr(data-placeholder);
            color: #999;
            cursor: text;
        }

        /* ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ */
        .image-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px 0;
            max-width: 100%;
            min-width: 100px;
        }

        /* ì—ë””í„° ë‚´ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .rich-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: block;
            transition: box-shadow 0.2s;
        }

        .rich-editor img:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ì´ë¯¸ì§€ ì„ íƒ ì‹œ */
        .image-wrapper.selected {
            outline: 3px solid #2196F3;
            outline-offset: 2px;
        }

        .image-wrapper.selected img {
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }

        /* ì‚­ì œ ë²„íŠ¼ */
        .image-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .image-wrapper:hover .image-delete-btn,
        .image-wrapper.selected .image-delete-btn {
            opacity: 1;
        }

        .image-delete-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        /* ë¦¬ì‚¬ì´ì¦ˆ ì˜ì—­ (ì˜¤ë¥¸ìª½ í•˜ë‹¨ ëª¨ì„œë¦¬) */
        .image-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30px;
            height: 30px;
            cursor: nwse-resize;
            z-index: 5;
        }

        /* ë¦¬ì‚¬ì´ì§• ì¤‘ */
        .image-wrapper.resizing {
            outline: 3px dashed #2196F3;
        }

        .image-wrapper.resizing img {
            pointer-events: none;
            user-select: none;
        }

        /* ì—ë””í„° íˆ´ë°” */
        .editor-toolbar {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <main class="main-content">
        <div class="container">
            <div class="write-container">
                <h2 id="pageTitle">ê²Œì‹œê¸€ ì‘ì„±</h2>
                <form id="writeForm" class="write-form">
                    <div class="form-group">
                        <label for="postTitle">ì œëª©</label>
                        <input type="text" id="postTitle" required placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label for="postContent">ë‚´ìš©</label>
                        <div class="content-editor-wrapper">
                            <div 
                                id="postContent" 
                                class="rich-editor"
                                contenteditable="true" 
                                data-placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ì‚½ì…í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.">
                            </div>
                            <div class="editor-toolbar">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="triggerImageUpload()">
                                    ğŸ“· ì´ë¯¸ì§€ ì‚½ì…
                                </button>
                                <input 
                                    type="file" 
                                    id="imageInput" 
                                    accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                                    multiple
                                    style="display: none;"
                                    onchange="handleImageSelection(event)">
                                <small style="color: #666; margin-left: 1rem;">
                                    ì´ë¯¸ì§€ëŠ” ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…ë©ë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ, ê° 5MB)
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">ë“±ë¡</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        let editMode = false;
        let editPostId = null;
        let originalPost = null;
        let pendingImageFiles = [];
        let imageCounter = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            authManager.updateUI();

            if (!authManager.isLoggedIn()) {
                showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            editPostId = urlParams.get('id');

            if (editPostId) {
                editMode = true;
                document.getElementById('pageTitle').textContent = 'ê²Œì‹œê¸€ ìˆ˜ì •';
                document.getElementById('submitBtn').textContent = 'ìˆ˜ì •';
                await loadPostForEdit(editPostId);
            }

            setupForm();
            setupEditorEvents();
        });

        async function loadPostForEdit(postId) {
            try {
                const post = await api.getPost(postId);
                originalPost = post;
                
                const currentUser = authManager.getCurrentUser();
                const isAuthor = currentUser && 
                    (currentUser.userId === post.user.userId || 
                     currentUser.nickname === post.user.nickname);
                
                if (!isAuthor) {
                    showError('ê²Œì‹œê¸€ ì‘ì„±ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = `/posts/${postId}`;
                    return;
                }
                
                document.getElementById('postTitle').value = post.title;
                
                // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ ì—ë””í„°ì— í‘œì‹œ
                const editor = document.getElementById('postContent');
                editor.innerHTML = convertMarkdownToHtml(post.body || '');
                
                // âœ… ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ì´ë¯¸ì§€ì— ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                addDeleteButtonsToExistingImages();
                
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/posts';
            }
        }

        // âœ… ê¸°ì¡´ ì´ë¯¸ì§€ì— ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ (ìˆ˜ì • ëª¨ë“œìš©)
        function addDeleteButtonsToExistingImages() {
            const editor = document.getElementById('postContent');
            
            // 1. image-wrapperê°€ ìˆëŠ” ì´ë¯¸ì§€ ì²˜ë¦¬
            const wrappers = editor.querySelectorAll('.image-wrapper');
            wrappers.forEach(wrapper => {
                // ì´ë¯¸ ì‚­ì œ ë²„íŠ¼ì´ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                if (wrapper.querySelector('.image-delete-btn')) {
                    return;
                }
                
                // ì‚­ì œ ë²„íŠ¼ ìƒì„±
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'image-delete-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.type = 'button';
                deleteBtn.setAttribute('contenteditable', 'false');
                
                // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    wrapper.remove();
                });
                
                // ë˜í¼ì— ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                wrapper.insertBefore(deleteBtn, wrapper.firstChild);
                
                // contenteditable ì†ì„± ì„¤ì •
                wrapper.setAttribute('contenteditable', 'false');
            });
            
            // 2. wrapperê°€ ì—†ëŠ” ë…ë¦½ img íƒœê·¸ ì²˜ë¦¬ (ë§ˆí¬ë‹¤ìš´ì—ì„œ ë³€í™˜ëœ ê²½ìš°)
            const standaloneImages = editor.querySelectorAll('img:not(.image-wrapper img)');
            standaloneImages.forEach(img => {
                const src = img.getAttribute('src');
                const alt = img.getAttribute('alt') || 'ì´ë¯¸ì§€';
                
                // âœ… ê¸°ì¡´ ì´ë¯¸ì§€ì˜ í¬ê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const existingWidth = img.style.width || img.getAttribute('width');
                const existingHeight = img.style.height || img.getAttribute('height');
                
                // image-wrapperë¡œ ê°ì‹¸ê¸°
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                wrapper.setAttribute('contenteditable', 'false');
                
                // âœ… í¬ê¸° ì •ë³´ê°€ ìˆìœ¼ë©´ wrapperì— ì ìš©
                if (existingWidth) {
                    wrapper.style.width = existingWidth.includes('px') ? existingWidth : existingWidth + 'px';
                }
                
                // ì‚­ì œ ë²„íŠ¼ ìƒì„±
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'image-delete-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.type = 'button';
                deleteBtn.setAttribute('contenteditable', 'false');
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (confirm('ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        wrapper.remove();
                    }
                });
                
                // ìƒˆ img íƒœê·¸ ìƒì„±
                const newImg = document.createElement('img');
                newImg.src = src;
                newImg.alt = alt;
                newImg.style.width = '100%';
                newImg.style.height = 'auto';
                
                // wrapper êµ¬ì„±
                wrapper.appendChild(deleteBtn);
                wrapper.appendChild(newImg);
                
                // ê¸°ì¡´ imgë¥¼ wrapperë¡œ êµì²´
                img.parentNode.replaceChild(wrapper, img);
            });
        }

        // âœ… ë§ˆí¬ë‹¤ìš´/HTMLì„ ì—ë””í„°ìš© HTMLë¡œ ë³€í™˜
        function convertMarkdownToHtml(content) {
            if (!content) return '';
            
            // ì´ë¯¸ HTML í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ìƒˆ ë°©ì‹)
            if (content.includes('<img') || content.includes('<div')) {
                return content;
            }
            
            // ìˆœìˆ˜ ë§ˆí¬ë‹¤ìš´ì´ë©´ ë³€í™˜ (êµ¬ ë°©ì‹ í˜¸í™˜)
            let html = content.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, url) => {
                return createImageWrapperHtml(url, alt, url);
            });
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        // âœ… ì´ë¯¸ì§€ ë˜í¼ HTML ìƒì„±
        function createImageWrapperHtml(src, alt, dataUrl) {
            return `<div class="image-wrapper" contenteditable="false">
                <img src="${src}" alt="${escapeHtml(alt)}" data-image-url="${dataUrl}">
                <button class="image-delete-btn" onclick="removeImage(this)" title="ì´ë¯¸ì§€ ì‚­ì œ">Ã—</button>
            </div>`;
        }

        // âœ… ì—ë””í„° ì´ë²¤íŠ¸ ì„¤ì •
        function setupEditorEvents() {
            const editor = document.getElementById('postContent');
            
            // Delete/Backspace í‚¤ë¡œ ì´ë¯¸ì§€ ì‚­ì œ
            editor.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const selectedElement = range.commonAncestorContainer;
                        
                        // ì„ íƒëœ ìš”ì†Œê°€ ì´ë¯¸ì§€ ë˜í¼ì¸ì§€ í™•ì¸
                        let imageWrapper = null;
                        if (selectedElement.nodeType === Node.ELEMENT_NODE && 
                            selectedElement.classList.contains('image-wrapper')) {
                            imageWrapper = selectedElement;
                        } else if (selectedElement.parentElement && 
                                   selectedElement.parentElement.classList.contains('image-wrapper')) {
                            imageWrapper = selectedElement.parentElement;
                        }
                        
                        if (imageWrapper) {
                            e.preventDefault();
                            removeImageWrapper(imageWrapper);
                        }
                    }
                }
            });

            // ì´ë¯¸ì§€ ë˜í¼ì— ë§ˆìš°ìŠ¤ë‹¤ìš´ ì´ë²¤íŠ¸ (ë¦¬ì‚¬ì´ì¦ˆ)
            editor.addEventListener('mousedown', (e) => {
                const target = e.target;
                const wrapper = target.closest('.image-wrapper');
                
                if (wrapper) {
                    const rect = wrapper.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    const offsetY = e.clientY - rect.top;
                    
                    // ì˜¤ë¥¸ìª½ í•˜ë‹¨ 30px ì˜ì—­ì¸ì§€ í™•ì¸
                    if (offsetX >= rect.width - 30 && offsetY >= rect.height - 30) {
                        e.preventDefault();
                        startResize(e, wrapper);
                    }
                }
            });
        }

        // ì´ë¯¸ì§€ ì„ íƒ íŠ¸ë¦¬ê±°
        function triggerImageUpload() {
            document.getElementById('imageInput').click();
        }

        // âœ… ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        function handleImageSelection(event) {
            const files = Array.from(event.target.files);
            const editor = document.getElementById('postContent');
            
            if (pendingImageFiles.length + files.length > 5) {
                showError('ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            for (const file of files) {
                if (!validateImageFile(file)) {
                    continue;
                }
                
                const tempId = `TEMP_IMAGE_${imageCounter++}`;
                pendingImageFiles.push({ id: tempId, file: file });
                
                const tempUrl = URL.createObjectURL(file);
                
                // ì´ë¯¸ì§€ ë˜í¼ ìƒì„±
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                wrapper.setAttribute('contenteditable', 'false');
                
                const img = document.createElement('img');
                img.src = tempUrl;
                img.alt = file.name;
                img.dataset.tempId = tempId;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'image-delete-btn';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.title = 'ì´ë¯¸ì§€ ì‚­ì œ';
                deleteBtn.onclick = function() { removeImage(this); };
                
                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                
                insertImageAtCursor(wrapper);
                
                const br = document.createElement('br');
                insertImageAtCursor(br);
            }
            
            event.target.value = '';
        }

        // âœ… ì´ë¯¸ì§€ ì‚­ì œ (ë²„íŠ¼ í´ë¦­)
        function removeImage(button) {
            const wrapper = button.parentElement;
            removeImageWrapper(wrapper);
        }

        // âœ… ì´ë¯¸ì§€ ë˜í¼ ì‚­ì œ
        function removeImageWrapper(wrapper) {
            const img = wrapper.querySelector('img');
            const tempId = img.dataset.tempId;
            
            // pendingImageFilesì—ì„œ ì œê±°
            if (tempId) {
                const index = pendingImageFiles.findIndex(item => item.id === tempId);
                if (index !== -1) {
                    // blob URL í•´ì œ
                    URL.revokeObjectURL(img.src);
                    pendingImageFiles.splice(index, 1);
                    console.log(`ì´ë¯¸ì§€ ì‚­ì œë¨: ${tempId}, ë‚¨ì€ ì´ë¯¸ì§€: ${pendingImageFiles.length}ê°œ`);
                }
            }
            
            // DOMì—ì„œ ì œê±°
            wrapper.remove();
            

        }

        // ì»¤ì„œ ìœ„ì¹˜ì— ìš”ì†Œ ì‚½ì…
        function insertImageAtCursor(element) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(element);
                
                range.setStartAfter(element);
                range.setEndAfter(element);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                document.getElementById('postContent').appendChild(element);
            }
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
        function validateImageFile(file) {
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
            
            if (!validTypes.includes(file.type)) {
                showError('PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return false;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showError('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return false;
            }
            
            return true;
        }

        // âœ… ì—ë””í„° ë‚´ìš©ì„ HTML ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ê¸° (í¬ê¸° ì •ë³´ ë³´ì¡´)
        function getEditorContent() {
            const editor = document.getElementById('postContent');
            
            // ì„ì‹œ divë¥¼ ë§Œë“¤ì–´ì„œ ì •ë¦¬
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = editor.innerHTML;
            
            // ì‚­ì œ ë²„íŠ¼ë§Œ ì œê±° (ì €ì¥í•  í•„ìš” ì—†ìŒ)
            tempDiv.querySelectorAll('.image-delete-btn').forEach(btn => btn.remove());
            
            // HTML ê·¸ëŒ€ë¡œ ë°˜í™˜ (image-wrapperì˜ style.width ë“± ëª¨ë“  ìŠ¤íƒ€ì¼ ë³´ì¡´)
            return tempDiv.innerHTML.trim();
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadPendingImages() {
            if (pendingImageFiles.length === 0) {
                return [];
            }

            try {
                const files = pendingImageFiles.map(item => item.file);
                const response = await api.uploadImages(files);
                return response.urls;
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                throw new Error(error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // âœ… ì„ì‹œ IDë¥¼ ì‹¤ì œ URLë¡œ êµì²´ (HTML ë°©ì‹)
        function replaceTemporaryIds(content, uploadedUrls) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // data-temp-idë¥¼ ê°€ì§„ img íƒœê·¸ ì°¾ì•„ì„œ ì‹¤ì œ URLë¡œ êµì²´
            pendingImageFiles.forEach((item, index) => {
                const tempId = item.id;
                const actualUrl = uploadedUrls[index];
                
                const img = tempDiv.querySelector(`img[data-temp-id="${tempId}"]`);
                if (img) {
                    img.src = actualUrl;
                    img.removeAttribute('data-temp-id');
                }
            });
            
            return tempDiv.innerHTML;
        }

        // âœ… ë³¸ë¬¸ì—ì„œ ì´ë¯¸ì§€ URL ì¶”ì¶œ (HTML ë°©ì‹)
        function extractImageUrls(content) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const urls = [];
            const images = tempDiv.querySelectorAll('img');
            
            images.forEach(img => {
                const src = img.getAttribute('src');
                // ì„ì‹œ IDë‚˜ blob URLì´ ì•„ë‹Œ ì‹¤ì œ URLë§Œ ì¶”ì¶œ
                if (src && !src.startsWith('TEMP_IMAGE_') && !src.startsWith('blob:')) {
                    urls.push(src);
                }
            });
            
            return urls;
        }

        function setupForm() {
            const writeForm = document.getElementById('writeForm');
            writeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('postTitle').value.trim();
                let body = getEditorContent();

                if (!title || !body) {
                    showError('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = editMode ? 'ìˆ˜ì • ì¤‘...' : 'ë“±ë¡ ì¤‘...';

                try {
                    let uploadedUrls = [];
                    if (pendingImageFiles.length > 0) {
                        submitBtn.textContent = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...';
                        uploadedUrls = await uploadPendingImages();
                        body = replaceTemporaryIds(body, uploadedUrls);
                    }

                    const imageUrls = extractImageUrls(body);
                    
                    console.log('ìµœì¢… body:', body);
                    console.log('ìµœì¢… imageUrls:', imageUrls);

                    submitBtn.textContent = editMode ? 'ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘...' : 'ê²Œì‹œê¸€ ë“±ë¡ ì¤‘...';
                    
                    if (editMode) {
                        await api.updatePost(editPostId, title, body, imageUrls);
                        showSuccess('ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        setTimeout(() => {
                            window.location.href = `/posts/${editPostId}`;
                        }, 1000);
                    } else {
                        await api.createPost(title, body, imageUrls);
                        showSuccess('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        setTimeout(() => {
                            window.location.href = '/posts';
                        }, 1000);
                    }
                } catch (error) {
                    console.error('ê²Œì‹œê¸€ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                    showError(error.message || 'ê²Œì‹œê¸€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = editMode ? 'ìˆ˜ì •' : 'ë“±ë¡';
                }
            });
        }

        function goBack() {
            if (editMode && editPostId) {
                window.location.href = `/posts/${editPostId}`;
            } else {
                window.location.href = '/posts';
            }
        }

        // âœ… ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ë³€ìˆ˜
        let resizingWrapper = null;
        let resizeStartX = 0;
        let resizeStartWidth = 0;

        // âœ… ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘
        function startResize(event, wrapper) {
            event.preventDefault();
            event.stopPropagation();
            
            resizingWrapper = wrapper;
            resizingWrapper.classList.add('resizing');
            
            resizeStartX = event.clientX;
            resizeStartWidth = resizingWrapper.offsetWidth;
            
            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        // âœ… ë¦¬ì‚¬ì´ì¦ˆ ì¤‘
        function doResize(event) {
            if (!resizingWrapper) return;
            
            const deltaX = event.clientX - resizeStartX;
            const newWidth = resizeStartWidth + deltaX;
            
            // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ
            const minWidth = 100;
            const maxWidth = resizingWrapper.parentElement.offsetWidth - 30;
            
            if (newWidth >= minWidth && newWidth <= maxWidth) {
                resizingWrapper.style.width = newWidth + 'px';
            }
        }

        // âœ… ë¦¬ì‚¬ì´ì¦ˆ ì¢…ë£Œ
        function stopResize() {
            if (resizingWrapper) {
                resizingWrapper.classList.remove('resizing');
                resizingWrapper = null;
            }
            
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>