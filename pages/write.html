<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸€ì“°ê¸° - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="write-container">
          <h2 id="pageTitle">ê²Œì‹œê¸€ ì‘ì„±</h2>
          <form id="writeForm" class="write-form">
            <div class="form-group">
              <label for="postTitle">ì œëª©</label>
              <input
                type="text"
                id="postTitle"
                required
                placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
              />
            </div>
            <div class="form-group">
              <label for="postContent">ë‚´ìš©</label>
              <div class="content-editor-wrapper">
                <div
                  id="postContent"
                  class="rich-editor"
                  contenteditable="true"
                  data-placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ì‚½ì…í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”."
                ></div>
                <div class="editor-toolbar">
                  <button
                    type="button"
                    class="btn btn-secondary btn-sm"
                    onclick="triggerImageUpload()"
                  >
                    ğŸ“· ì´ë¯¸ì§€ ì‚½ì…
                  </button>
                  <input
                    type="file"
                    id="imageInput"
                    accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                    multiple
                    style="display: none"
                    onchange="handleImageSelection(event)"
                  />
                  <small style="color: #666; margin-left: 1rem">
                    ì´ë¯¸ì§€ëŠ” ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…ë©ë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ, ê° 5MB)
                  </small>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goBack()"
              >
                ì·¨ì†Œ
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                ë“±ë¡
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
      let editMode = false;
      let editPostId = null;
      let originalPost = null;
      let pendingImageFiles = [];
      let imageCounter = 0;

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("ê¸€ì“°ê¸° í˜ì´ì§€ ì´ˆê¸°í™”");

        try {
          await authManager.init();

          console.log("ë¡œê·¸ì¸ ìƒíƒœ:", authManager.isLoggedIn());
          console.log("í˜„ì¬ ì‚¬ìš©ì:", authManager.getCurrentUser());

          if (!authManager.isLoggedIn()) {
            console.warn("ë¡œê·¸ì¸ í•„ìš” - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™");
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

            setTimeout(() => {
              window.location.href = "/login?returnUrl=/posts/write";
            }, 1500);
            return;
          }

          const urlParams = new URLSearchParams(window.location.search);
          editPostId = urlParams.get("id");

          if (editPostId) {
            editMode = true;
            document.getElementById("pageTitle").textContent = "ê²Œì‹œê¸€ ìˆ˜ì •";
            document.getElementById("submitBtn").textContent = "ìˆ˜ì •";
            await loadPostForEdit(editPostId);
          }

          setupForm();
          setupEditorEvents();
        } catch (error) {
          console.error("í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
          showError("í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      });

      async function loadPostForEdit(postId) {
        try {
          const post = await api.getPost(postId);
          originalPost = post;

          const currentUser = authManager.getCurrentUser();
          const isAuthor =
            currentUser &&
            (currentUser.userId === post.user.userId ||
              currentUser.nickname === post.user.nickname);

          if (!isAuthor) {
            showError("ê²Œì‹œê¸€ ì‘ì„±ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            window.location.href = `/posts/${postId}`;
            return;
          }

          document.getElementById("postTitle").value = post.title;

          const editor = document.getElementById("postContent");
          editor.innerHTML = convertMarkdownToHtml(post.body || "");

          addDeleteButtonsToExistingImages();
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:", error);
          showError("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          window.location.href = "/posts";
        }
      }

      function addDeleteButtonsToExistingImages() {
        const editor = document.getElementById("postContent");

        const wrappers = editor.querySelectorAll(".image-wrapper");
        wrappers.forEach((wrapper) => {
          if (wrapper.querySelector(".image-delete-btn")) {
            return;
          }

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "image-delete-btn";
          deleteBtn.textContent = "Ã—";
          deleteBtn.type = "button";
          deleteBtn.setAttribute("contenteditable", "false");

          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            wrapper.remove();
          });

          wrapper.insertBefore(deleteBtn, wrapper.firstChild);
          wrapper.setAttribute("contenteditable", "false");
        });

        const standaloneImages = editor.querySelectorAll(
          "img:not(.image-wrapper img)"
        );
        standaloneImages.forEach((img) => {
          const src = img.getAttribute("src");
          const alt = img.getAttribute("alt") || "ì´ë¯¸ì§€";

          const existingWidth = img.style.width || img.getAttribute("width");

          const wrapper = document.createElement("div");
          wrapper.className = "image-wrapper";
          wrapper.setAttribute("contenteditable", "false");

          if (existingWidth) {
            wrapper.style.width = existingWidth.includes("px")
              ? existingWidth
              : existingWidth + "px";
          }

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "image-delete-btn";
          deleteBtn.textContent = "Ã—";
          deleteBtn.type = "button";
          deleteBtn.setAttribute("contenteditable", "false");
          deleteBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (confirm("ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              wrapper.remove();
            }
          });

          const newImg = document.createElement("img");
          newImg.src = src;
          newImg.alt = alt;
          newImg.style.width = "100%";
          newImg.style.height = "auto";

          wrapper.appendChild(deleteBtn);
          wrapper.appendChild(newImg);

          img.parentNode.replaceChild(wrapper, img);
        });
      }

      function convertMarkdownToHtml(content) {
        if (!content) return "";

        if (content.includes("<img") || content.includes("<div")) {
          return content;
        }

        let html = content.replace(
          /!\[(.*?)\]\((.*?)\)/g,
          (match, alt, url) => {
            return createImageWrapperHtml(url, alt, url);
          }
        );
        html = html.replace(/\n/g, "<br>");
        return html;
      }

      function createImageWrapperHtml(src, alt, dataUrl) {
        return `<div class="image-wrapper" contenteditable="false">
                <button class="image-delete-btn" onclick="removeImage(this)" title="ì´ë¯¸ì§€ ì‚­ì œ" type="button">Ã—</button>
                <img src="${src}" alt="${escapeHtml(alt)}" data-image-url="${dataUrl}">
            </div>`;
      }

      function setupEditorEvents() {
        const editor = document.getElementById("postContent");

        // âœ… ì—ë””í„° í´ë¦­ ì‹œ í¬ì»¤ìŠ¤
        editor.addEventListener("click", function(e) {
          if (!e.target.closest('.image-wrapper') && !e.target.closest('.image-delete-btn')) {
            this.focus();
          }
        });

        editor.addEventListener("keydown", (e) => {
          if (e.key === "Delete" || e.key === "Backspace") {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
              const range = selection.getRangeAt(0);
              const selectedElement = range.commonAncestorContainer;

              let imageWrapper = null;
              if (
                selectedElement.nodeType === Node.ELEMENT_NODE &&
                selectedElement.classList.contains("image-wrapper")
              ) {
                imageWrapper = selectedElement;
              } else if (
                selectedElement.parentElement &&
                selectedElement.parentElement.classList.contains("image-wrapper")
              ) {
                imageWrapper = selectedElement.parentElement;
              }

              if (imageWrapper) {
                e.preventDefault();
                removeImageWrapper(imageWrapper);
              }
            }
          }
        });

        editor.addEventListener("mousedown", (e) => {
          const target = e.target;
          const wrapper = target.closest(".image-wrapper");

          if (wrapper) {
            const rect = wrapper.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const offsetY = e.clientY - rect.top;

            if (offsetX >= rect.width - 30 && offsetY >= rect.height - 30) {
              e.preventDefault();
              startResize(e, wrapper);
            }
          }
        });
      }

      function triggerImageUpload() {
        document.getElementById("imageInput").click();
      }

      function handleImageSelection(event) {
        const files = Array.from(event.target.files);
        const editor = document.getElementById("postContent");

        console.log("ì´ë¯¸ì§€ ì„ íƒë¨:", files.length + "ê°œ");

        if (pendingImageFiles.length + files.length > 5) {
          showError("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return;
        }

        // âœ… ì—ë””í„°ì— í¬ì»¤ìŠ¤ (ì¤‘ìš”!)
        editor.focus();

        for (const file of files) {
          if (!validateImageFile(file)) {
            continue;
          }

          const tempId = `TEMP_IMAGE_${imageCounter++}`;
          pendingImageFiles.push({ id: tempId, file: file });

          const tempUrl = URL.createObjectURL(file);

          console.log(`ì´ë¯¸ì§€ ì¶”ê°€: ${tempId}, blob URL: ${tempUrl}`);

          // âœ… ì´ë¯¸ì§€ ë˜í¼ ìƒì„±
          const wrapper = document.createElement("div");
          wrapper.className = "image-wrapper";
          wrapper.setAttribute("contenteditable", "false");

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "image-delete-btn";
          deleteBtn.innerHTML = "Ã—";
          deleteBtn.title = "ì´ë¯¸ì§€ ì‚­ì œ";
          deleteBtn.type = "button";
          deleteBtn.setAttribute("contenteditable", "false");
          deleteBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            removeImage(this);
          };

          const img = document.createElement("img");
          img.src = tempUrl;
          img.alt = file.name;
          img.dataset.tempId = tempId;

          wrapper.appendChild(deleteBtn);
          wrapper.appendChild(img);

          // âœ… ì—ë””í„° ë‚´ë¶€ì— ì‚½ì…
          insertImageAtCursor(wrapper, editor);

          // âœ… ì¤„ë°”ê¿ˆ ì¶”ê°€
          const br = document.createElement("br");
          insertImageAtCursor(br, editor);
        }

        event.target.value = "";
        console.log("í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì´ë¯¸ì§€:", pendingImageFiles.length + "ê°œ");
      }

      function removeImage(button) {
        const wrapper = button.parentElement;
        removeImageWrapper(wrapper);
      }

      function removeImageWrapper(wrapper) {
        const img = wrapper.querySelector("img");
        const tempId = img ? img.dataset.tempId : null;

        if (tempId) {
          const index = pendingImageFiles.findIndex(
            (item) => item.id === tempId
          );
          if (index !== -1) {
            if (img.src.startsWith("blob:")) {
              URL.revokeObjectURL(img.src);
            }
            pendingImageFiles.splice(index, 1);
            console.log(
              `ì´ë¯¸ì§€ ì‚­ì œë¨: ${tempId}, ë‚¨ì€ ì´ë¯¸ì§€: ${pendingImageFiles.length}ê°œ`
            );
          }
        }

        wrapper.remove();
      }

      /**
       * âœ… ì»¤ì„œ ìœ„ì¹˜ì— ìš”ì†Œ ì‚½ì… (ê°œì„ ëœ ë²„ì „)
       */
      function insertImageAtCursor(element, editor) {
        console.log("insertImageAtCursor í˜¸ì¶œ");
        console.log("ì—ë””í„°:", editor);
        console.log("í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œ:", document.activeElement);

        // âœ… ì—ë””í„°ê°€ í¬ì»¤ìŠ¤ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (document.activeElement !== editor) {
          console.log("ì—ë””í„°ì— í¬ì»¤ìŠ¤ ì„¤ì •");
          editor.focus();
        }

        const selection = window.getSelection();
        console.log("ì„ íƒ ì˜ì—­ ê°œìˆ˜:", selection.rangeCount);

        // âœ… ì„ íƒ ì˜ì—­ì´ ì—ë””í„° ë‚´ë¶€ì— ìˆëŠ”ì§€ í™•ì¸
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          console.log("ì„ íƒ ì˜ì—­ ì»¨í…Œì´ë„ˆ:", range.commonAncestorContainer);
          console.log("ì—ë””í„° í¬í•¨ ì—¬ë¶€:", editor.contains(range.commonAncestorContainer));

          if (editor.contains(range.commonAncestorContainer)) {
            // âœ… ì—ë””í„° ë‚´ë¶€ì— ì‚½ì…
            console.log("âœ… ì»¤ì„œ ìœ„ì¹˜ì— ì´ë¯¸ì§€ ì‚½ì…");
            range.deleteContents();
            range.insertNode(element);

            // ì»¤ì„œë¥¼ ì‚½ì…ëœ ìš”ì†Œ ë’¤ë¡œ ì´ë™
            range.setStartAfter(element);
            range.setEndAfter(element);
            selection.removeAllRanges();
            selection.addRange(range);

            return;
          }
        }

        // âœ… ì»¤ì„œê°€ ì—ë””í„° ë°–ì— ìˆê±°ë‚˜ ì„ íƒ ì˜ì—­ì´ ì—†ëŠ” ê²½ìš°
        // ì—ë””í„°ì˜ ë§ˆì§€ë§‰ì— ì¶”ê°€
        console.log("âš ï¸ ì—ë””í„° ë§ˆì§€ë§‰ì— ì´ë¯¸ì§€ ì¶”ê°€");
        editor.appendChild(element);

        // âœ… ì»¤ì„œë¥¼ ì‚½ì…ëœ ìš”ì†Œ ë’¤ë¡œ ì´ë™
        const range = document.createRange();
        const sel = window.getSelection();

        range.setStartAfter(element);
        range.collapse(true);

        sel.removeAllRanges();
        sel.addRange(range);

        // âœ… ìŠ¤í¬ë¡¤ì„ ì‚½ì…ëœ ì´ë¯¸ì§€ ìœ„ì¹˜ë¡œ ì´ë™
        element.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function validateImageFile(file) {
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];

        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return false;
        }

        if (file.size > 5 * 1024 * 1024) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          return false;
        }

        return true;
      }

      function getEditorContent() {
        const editor = document.getElementById("postContent");

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = editor.innerHTML;

        tempDiv
          .querySelectorAll(".image-delete-btn")
          .forEach((btn) => btn.remove());

        return tempDiv.innerHTML.trim();
      }

      async function uploadPendingImages() {
        if (pendingImageFiles.length === 0) {
          console.log("ì—…ë¡œë“œí•  ì´ë¯¸ì§€ ì—†ìŒ");
          return [];
        }

        console.log(`${pendingImageFiles.length}ê°œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘`);

        try {
          const files = pendingImageFiles.map((item) => item.file);
          const response = await api.uploadImages(files);
          console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:", response.urls);
          return response.urls;
        } catch (error) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
          throw new Error(error.message || "ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function replaceTemporaryIds(content, uploadedUrls) {
        console.log("ì„ì‹œ IDë¥¼ ì‹¤ì œ URLë¡œ êµì²´ ì‹œì‘");
        console.log("ì—…ë¡œë“œëœ URL:", uploadedUrls);

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = content;

        pendingImageFiles.forEach((item, index) => {
          const tempId = item.id;
          const actualUrl = uploadedUrls[index];

          console.log(`${tempId} â†’ ${actualUrl}`);

          const img = tempDiv.querySelector(`img[data-temp-id="${tempId}"]`);
          if (img) {
            img.src = actualUrl;
            img.removeAttribute("data-temp-id");
            console.log(`âœ… ${tempId} êµì²´ ì™„ë£Œ`);
          } else {
            console.warn(`âš ï¸ ${tempId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          }
        });

        return tempDiv.innerHTML;
      }

      function extractImageUrls(content) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = content;

        const urls = [];
        const images = tempDiv.querySelectorAll("img");

        images.forEach((img) => {
          const src = img.getAttribute("src");
          if (
            src &&
            !src.startsWith("TEMP_IMAGE_") &&
            !src.startsWith("blob:")
          ) {
            urls.push(src);
          }
        });

        console.log("ì¶”ì¶œëœ ì´ë¯¸ì§€ URL:", urls);
        return urls;
      }

      function setupForm() {
        const writeForm = document.getElementById("writeForm");
        writeForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const title = document.getElementById("postTitle").value.trim();
          let body = getEditorContent();

          console.log("í¼ ì œì¶œ ì‹œì‘");
          console.log("ì œëª©:", title);
          console.log("ë³¸ë¬¸ (HTML):", body);
          console.log("ëŒ€ê¸° ì¤‘ì¸ ì´ë¯¸ì§€:", pendingImageFiles.length + "ê°œ");

          if (!title || !body) {
            showError("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          const submitBtn = document.getElementById("submitBtn");
          submitBtn.disabled = true;
          submitBtn.textContent = editMode ? "ìˆ˜ì • ì¤‘..." : "ë“±ë¡ ì¤‘...";

          try {
            let uploadedUrls = [];
            if (pendingImageFiles.length > 0) {
              submitBtn.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
              uploadedUrls = await uploadPendingImages();
              body = replaceTemporaryIds(body, uploadedUrls);
            }

            const imageUrls = extractImageUrls(body);

            console.log("ìµœì¢… body:", body);
            console.log("ìµœì¢… imageUrls:", imageUrls);

            submitBtn.textContent = editMode
              ? "ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘..."
              : "ê²Œì‹œê¸€ ë“±ë¡ ì¤‘...";

            if (editMode) {
              await api.updatePost(editPostId, title, body, imageUrls);
              showSuccess("ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

              setTimeout(() => {
                window.location.href = `/posts/${editPostId}`;
              }, 1000);
            } else {
              const response = await api.createPost(title, body, imageUrls);
              console.log("ê²Œì‹œê¸€ ì‘ì„± ì‘ë‹µ:", response);
              showSuccess("ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");

              setTimeout(() => {
                window.location.href = "/posts";
              }, 1000);
            }
          } catch (error) {
            console.error("ê²Œì‹œê¸€ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
            showError(error.message || "ê²Œì‹œê¸€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            submitBtn.disabled = false;
            submitBtn.textContent = editMode ? "ìˆ˜ì •" : "ë“±ë¡";
          }
        });
      }

      function goBack() {
        if (editMode && editPostId) {
          window.location.href = `/posts/${editPostId}`;
        } else {
          window.location.href = "/posts";
        }
      }

      let resizingWrapper = null;
      let resizeStartX = 0;
      let resizeStartWidth = 0;

      function startResize(event, wrapper) {
        event.preventDefault();
        event.stopPropagation();

        resizingWrapper = wrapper;
        resizingWrapper.classList.add("resizing");

        resizeStartX = event.clientX;
        resizeStartWidth = resizingWrapper.offsetWidth;

        document.addEventListener("mousemove", doResize);
        document.addEventListener("mouseup", stopResize);
      }

      function doResize(event) {
        if (!resizingWrapper) return;

        const deltaX = event.clientX - resizeStartX;
        const newWidth = resizeStartWidth + deltaX;

        const minWidth = 100;
        const maxWidth = resizingWrapper.parentElement.offsetWidth - 30;

        if (newWidth >= minWidth && newWidth <= maxWidth) {
          resizingWrapper.style.width = newWidth + "px";
        }
      }

      function stopResize() {
        if (resizingWrapper) {
          resizingWrapper.classList.remove("resizing");
          resizingWrapper = null;
        }

        document.removeEventListener("mousemove", doResize);
        document.removeEventListener("mouseup", stopResize);
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>