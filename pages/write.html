<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ì“°ê¸° - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* contenteditable ì—ë””í„° ìŠ¤íƒ€ì¼ */
        .rich-editor {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            outline: none;
        }

        .rich-editor:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        /* placeholder ìŠ¤íƒ€ì¼ */
        .rich-editor:empty:before {
            content: attr(data-placeholder);
            color: #999;
            cursor: text;
        }

        /* ì—ë””í„° ë‚´ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .rich-editor img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: block;
            cursor: pointer;
        }

        .rich-editor img:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ì—ë””í„° íˆ´ë°” */
        .editor-toolbar {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <main class="main-content">
        <div class="container">
            <div class="write-container">
                <h2 id="pageTitle">ê²Œì‹œê¸€ ì‘ì„±</h2>
                <form id="writeForm" class="write-form">
                    <div class="form-group">
                        <label for="postTitle">ì œëª©</label>
                        <input type="text" id="postTitle" required placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label for="postContent">ë‚´ìš©</label>
                        <div class="content-editor-wrapper">
                            <div 
                                id="postContent" 
                                class="rich-editor"
                                contenteditable="true" 
                                data-placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ì‚½ì…í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.">
                            </div>
                            <div class="editor-toolbar">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="triggerImageUpload()">
                                    ğŸ“· ì´ë¯¸ì§€ ì‚½ì…
                                </button>
                                <input 
                                    type="file" 
                                    id="imageInput" 
                                    accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                                    multiple
                                    style="display: none;"
                                    onchange="handleImageSelection(event)">
                                <small style="color: #666; margin-left: 1rem;">
                                    ì´ë¯¸ì§€ëŠ” ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…ë©ë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ, ê° 5MB)
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">ë“±ë¡</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        let editMode = false;
        let editPostId = null;
        let originalPost = null;
        let pendingImageFiles = [];
        let imageCounter = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            authManager.updateUI();

            if (!authManager.isLoggedIn()) {
                showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            editPostId = urlParams.get('id');

            if (editPostId) {
                editMode = true;
                document.getElementById('pageTitle').textContent = 'ê²Œì‹œê¸€ ìˆ˜ì •';
                document.getElementById('submitBtn').textContent = 'ìˆ˜ì •';
                await loadPostForEdit(editPostId);
            }

            setupForm();
        });

        async function loadPostForEdit(postId) {
            try {
                const post = await api.getPost(postId);
                originalPost = post;
                
                const currentUser = authManager.getCurrentUser();
                const isAuthor = currentUser && 
                    (currentUser.userId === post.user.userId || 
                     currentUser.nickname === post.user.nickname);
                
                if (!isAuthor) {
                    showError('ê²Œì‹œê¸€ ì‘ì„±ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = `/posts/${postId}`;
                    return;
                }
                
                document.getElementById('postTitle').value = post.title;
                
                // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ ì—ë””í„°ì— í‘œì‹œ
                const editor = document.getElementById('postContent');
                editor.innerHTML = convertMarkdownToHtml(post.body || '');
                
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/posts';
            }
        }

        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (ì—ë””í„° í‘œì‹œìš©)
        function convertMarkdownToHtml(markdown) {
            let html = markdown.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, url) => {
                return `<img src="${url}" alt="${escapeHtml(alt)}" data-image-url="${url}">`;
            });
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        // ì´ë¯¸ì§€ ì„ íƒ íŠ¸ë¦¬ê±°
        function triggerImageUpload() {
            document.getElementById('imageInput').click();
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        function handleImageSelection(event) {
            const files = Array.from(event.target.files);
            const editor = document.getElementById('postContent');
            
            if (pendingImageFiles.length + files.length > 5) {
                showError('ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            for (const file of files) {
                if (!validateImageFile(file)) {
                    continue;
                }
                
                const tempId = `TEMP_IMAGE_${imageCounter++}`;
                pendingImageFiles.push({ id: tempId, file: file });
                
                const tempUrl = URL.createObjectURL(file);
                
                const img = document.createElement('img');
                img.src = tempUrl;
                img.alt = file.name;
                img.dataset.tempId = tempId;
                
                insertImageAtCursor(img);
                
                const br = document.createElement('br');
                insertImageAtCursor(br);
            }
            
            event.target.value = '';
        }

        // ì»¤ì„œ ìœ„ì¹˜ì— ìš”ì†Œ ì‚½ì…
        function insertImageAtCursor(element) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(element);
                
                range.setStartAfter(element);
                range.setEndAfter(element);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                document.getElementById('postContent').appendChild(element);
            }
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
        function validateImageFile(file) {
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
            
            if (!validTypes.includes(file.type)) {
                showError('PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return false;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showError('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return false;
            }
            
            return true;
        }

        // HTMLì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜
        function convertHtmlToMarkdown(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            let markdown = '';
            
            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    markdown += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.tagName === 'IMG') {
                        const alt = node.getAttribute('alt') || 'ì´ë¯¸ì§€';
                        const tempId = node.dataset.tempId;
                        if (tempId) {
                            markdown += `![${alt}](${tempId})`;
                        } else {
                            const src = node.getAttribute('src');
                            markdown += `![${alt}](${src})`;
                        }
                        markdown += '\n';
                    } else if (node.tagName === 'BR') {
                        markdown += '\n';
                    } else if (node.tagName === 'DIV' || node.tagName === 'P') {
                        Array.from(node.childNodes).forEach(processNode);
                        markdown += '\n';
                    } else {
                        Array.from(node.childNodes).forEach(processNode);
                    }
                }
            }
            
            Array.from(tempDiv.childNodes).forEach(processNode);
            return markdown.trim();
        }

        // ì—ë””í„° ë‚´ìš©ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        function getEditorContent() {
            const editor = document.getElementById('postContent');
            return convertHtmlToMarkdown(editor.innerHTML);
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadPendingImages() {
            if (pendingImageFiles.length === 0) {
                return [];
            }

            try {
                const files = pendingImageFiles.map(item => item.file);
                const response = await api.uploadImages(files);
                return response.urls;
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                throw new Error(error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì„ì‹œ IDë¥¼ ì‹¤ì œ URLë¡œ êµì²´
        function replaceTemporaryIds(content, uploadedUrls) {
            let updatedContent = content;
            
            pendingImageFiles.forEach((item, index) => {
                const tempId = item.id;
                const actualUrl = uploadedUrls[index];
                updatedContent = updatedContent.replace(
                    new RegExp(`\\]\\(${tempId}\\)`, 'g'),
                    `](${actualUrl})`
                );
            });
            
            return updatedContent;
        }

        // ë³¸ë¬¸ì—ì„œ ì´ë¯¸ì§€ URL ì¶”ì¶œ
        function extractImageUrls(content) {
            const markdownPattern = /!\[.*?\]\((.*?)\)/g;
            const urls = [];
            let match;
            
            while ((match = markdownPattern.exec(content)) !== null) {
                const url = match[1];
                if (!url.startsWith('TEMP_IMAGE_')) {
                    urls.push(url);
                }
            }
            
            return urls;
        }

        function setupForm() {
            const writeForm = document.getElementById('writeForm');
            writeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('postTitle').value.trim();
                let body = getEditorContent();

                if (!title || !body) {
                    showError('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = editMode ? 'ìˆ˜ì • ì¤‘...' : 'ë“±ë¡ ì¤‘...';

                try {
                    let uploadedUrls = [];
                    if (pendingImageFiles.length > 0) {
                        submitBtn.textContent = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...';
                        uploadedUrls = await uploadPendingImages();
                        body = replaceTemporaryIds(body, uploadedUrls);
                    }

                    const imageUrls = extractImageUrls(body);
                    
                    console.log('ìµœì¢… body:', body);
                    console.log('ìµœì¢… imageUrls:', imageUrls);

                    submitBtn.textContent = editMode ? 'ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘...' : 'ê²Œì‹œê¸€ ë“±ë¡ ì¤‘...';
                    
                    if (editMode) {
                        await api.updatePost(editPostId, title, body, imageUrls);
                        showSuccess('ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        setTimeout(() => {
                            window.location.href = `/posts/${editPostId}`;
                        }, 1000);
                    } else {
                        await api.createPost(title, body, imageUrls);
                        showSuccess('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        setTimeout(() => {
                            window.location.href = '/posts';
                        }, 1000);
                    }
                } catch (error) {
                    console.error('ê²Œì‹œê¸€ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                    showError(error.message || 'ê²Œì‹œê¸€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = editMode ? 'ìˆ˜ì •' : 'ë“±ë¡';
                }
            });
        }

        function goBack() {
            if (editMode && editPostId) {
                window.location.href = `/posts/${editPostId}`;
            } else {
                window.location.href = '/posts';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>