<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원정보 수정 - 커뮤니티</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="profile-edit-container">
          <h2>회원정보 수정</h2>

          <form id="profileEditForm" class="profile-edit-form">
            <div class="profile-edit-image">
              <div
                class="profile-edit-preview"
                onclick="triggerProfileFileInput()"
              >
                <img
                  src=""
                  alt="프로필"
                  id="currentProfileImg"
                  style="display: none"
                />
                <div class="profile-edit-default" id="defaultProfileIcon">
                  <span>👤</span>
                </div>
                <button type="button" class="profile-change-btn">변경</button>
                <button
                  type="button"
                  class="profile-remove-btn"
                  id="removeImageBtn"
                  style="display: none"
                  onclick="removeProfileImage(event)"
                  title="이미지 삭제"
                >
                  ×
                </button>
              </div>
              <input
                type="file"
                id="profileImageInput"
                accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                style="display: none"
                onchange="handleProfileImageChange(event)"
              />
            </div>

            <div class="form-group">
              <label for="userEmail">이메일</label>
              <input type="email" id="userEmail" readonly disabled />
              <span class="helper-text">* 이메일은 변경할 수 없습니다</span>
            </div>

            <div class="form-group">
              <label for="userNickname"
                >닉네임 <span class="required">*</span></label
              >
              <input
                type="text"
                id="userNickname"
                required
                placeholder="닉네임을 입력하세요"
              />
              <div class="form-message">
                <span class="helper-text">* 띄어쓰기 불가능, 10자 이내</span>
                <span class="error-text" id="nicknameError"></span>
              </div>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goBack()"
              >
                취소
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                수정하기
              </button>
            </div>
          </form>

          <div class="account-delete-section">
            <button
              type="button"
              class="btn btn-danger btn-block"
              onclick="deleteAccount()"
            >
              회원 탈퇴
            </button>
          </div>
        </div>
      </div>
    </main>

    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/initService.js"></script>
    <script>
      let selectedProfileImageFile = null;
      let currentBlobUrl = null;
      let originalNickname = "";
      let hasImageChanged = false;

      document.addEventListener("DOMContentLoaded", async () => {
        if (!authManager.isLoggedIn()) {
          showError("로그인이 필요합니다");
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }

        await loadUserInfo();
        setupValidation();
      });

      function setupValidation() {
        const nicknameInput = document.getElementById("userNickname");

        nicknameInput.addEventListener("blur", validateNickname);
        nicknameInput.addEventListener("input", () =>
          clearFieldError(nicknameInput, "nicknameError")
        );
      }

      function showFieldError(input, errorId, message) {
        input.classList.add("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = message;
        errorElement.classList.add("show");

        const formMessage = errorElement.closest(".form-message");
        if (formMessage) {
          const helperText = formMessage.querySelector(".helper-text");
          if (helperText) {
            helperText.style.opacity = "0";
            helperText.style.visibility = "hidden";
          }
        }
      }

      function clearFieldError(input, errorId) {
        input.classList.remove("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = "";
        errorElement.classList.remove("show");

        const formMessage = errorElement.closest(".form-message");
        if (formMessage) {
          const helperText = formMessage.querySelector(".helper-text");
          if (helperText) {
            helperText.style.opacity = "1";
            helperText.style.visibility = "visible";
          }
        }
      }

      function validateNickname() {
        const nicknameInput = document.getElementById("userNickname");
        const nickname = nicknameInput.value.trim();

        clearFieldError(nicknameInput, "nicknameError");

        if (nickname.length === 0) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "닉네임을 입력해주세요"
          );
          return false;
        }

        if (/\s/.test(nickname)) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "띄어쓰기를 없애주세요"
          );
          return false;
        }

        if (nickname.length > 10) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "닉네임은 최대 10자까지 작성 가능합니다"
          );
          return false;
        }

        return true;
      }

      async function loadUserInfo() {
        try {
          const user = await userService.getUserProfile();

          document.getElementById("userEmail").value = user.email;
          document.getElementById("userNickname").value = user.nickname;
          originalNickname = user.nickname;

          if (user.profileImageUrl) {
            const profileImg = document.getElementById("currentProfileImg");
            const defaultIcon = document.getElementById("defaultProfileIcon");
            const removeBtn = document.getElementById("removeImageBtn");

            profileImg.src = user.profileImageUrl;
            profileImg.style.display = "block";
            defaultIcon.style.display = "none";
            removeBtn.style.display = "flex";
          }

          console.log("사용자 정보 로드 완료");
        } catch (error) {
          console.error("사용자 정보 로드 실패:", error);

          if (error.status === 401) {
            showError("로그인이 필요합니다");
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } else {
            showError("사용자 정보를 불러오는데 실패했습니다");
          }
        }
      }

      function triggerProfileFileInput() {
        document.getElementById("profileImageInput").click();
      }

      function handleProfileImageChange(event) {
        const file = event.target.files[0];

        if (!file) return;

        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP 형식의 이미지만 업로드 가능합니다");
          event.target.value = "";
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          showError("이미지 크기는 5MB 이하여야 합니다");
          event.target.value = "";
          return;
        }

        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }

        selectedProfileImageFile = file;
        hasImageChanged = true;

        currentBlobUrl = URL.createObjectURL(file);

        const profileImg = document.getElementById("currentProfileImg");
        const defaultIcon = document.getElementById("defaultProfileIcon");
        const removeBtn = document.getElementById("removeImageBtn");

        profileImg.src = currentBlobUrl;
        profileImg.style.display = "block";
        defaultIcon.style.display = "none";
        removeBtn.style.display = "flex";

        console.log("이미지 선택 완료");
      }

      function removeProfileImage(event) {
        event.stopPropagation();

        if (!confirm("프로필 이미지를 제거하시겠습니까?")) {
          return;
        }

        selectedProfileImageFile = null;
        hasImageChanged = true;

        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
          currentBlobUrl = null;
        }

        const profileImg = document.getElementById("currentProfileImg");
        const defaultIcon = document.getElementById("defaultProfileIcon");
        const removeBtn = document.getElementById("removeImageBtn");
        const fileInput = document.getElementById("profileImageInput");

        profileImg.src = "";
        profileImg.style.display = "none";
        defaultIcon.style.display = "block";
        removeBtn.style.display = "none";
        fileInput.value = "";

        console.log("이미지 제거 완료");
      }

      document
        .getElementById("profileEditForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!validateNickname()) {
            return;
          }

          const nickname = document.getElementById("userNickname").value.trim();
          const submitBtn = document.getElementById("submitBtn");

          if (nickname === originalNickname && !hasImageChanged) {
            showError("변경된 내용이 없습니다");
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = "수정 중...";

          try {
            const updatedUser = await userService.updateUserProfile(
              nickname,
              selectedProfileImageFile
            );
            authManager.setUser(updatedUser);
            authManager.updateUI();

            showSuccess("회원정보가 수정되었습니다!");

            if (currentBlobUrl) {
              URL.revokeObjectURL(currentBlobUrl);
            }

            setTimeout(() => {
              window.location.href = "/posts";
            }, 1500);
          } catch (error) {
            console.error("회원정보 수정 실패:", error);

            let errorMessage = "회원정보 수정에 실패했습니다";

            if (error.status === 409) {
              if (error.message && error.message.includes("닉네임")) {
                showFieldError(
                  document.getElementById("userNickname"),
                  "nicknameError",
                  "중복된 닉네임입니다"
                );
                submitBtn.disabled = false;
                submitBtn.textContent = "수정하기";
                return;
              }
            } else if (error.status === 401) {
              errorMessage = "로그인이 필요합니다";
            } else if (error.status === 400) {
              errorMessage = error.message || "입력 정보를 확인해주세요";
            } else if (error.message) {
              errorMessage = error.message;
            }

            showError(errorMessage);

            submitBtn.disabled = false;
            submitBtn.textContent = "수정하기";
          }
        });

      async function deleteAccount() {
        if (
          !confirm(
            "회원을 탈퇴하시겠습니까?\n\n⚠️ 1주일 이내에 재로그인이 없을 시 계정이 영구 삭제됩니다."
          )
        ) {
          return;
        }

        if (
          !confirm("정말로 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.")
        ) {
          return;
        }

        try {
          await userService.deleteAccount();

          showSuccess("회원 탈퇴가 완료되었습니다. 이용해주셔서 감사합니다");

          if (currentBlobUrl) {
            URL.revokeObjectURL(currentBlobUrl);
          }

          setTimeout(() => {
            authManager.logout();
          }, 1500);
        } catch (error) {
          console.error("회원 탈퇴 실패:", error);

          let errorMessage = "회원 탈퇴에 실패했습니다";

          if (error.status === 401) {
            errorMessage = "로그인이 필요합니다";
          } else if (error.message) {
            errorMessage = error.message;
          }

          showError(errorMessage);
        }
      }

      function goBack() {
        const nickname = document.getElementById("userNickname").value.trim();

        if (nickname !== originalNickname || hasImageChanged) {
          if (!confirm("변경된 내용이 있습니다. 정말 취소하시겠습니까?")) {
            return;
          }
        }

        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }

        window.location.href = "/posts";
      }

      window.addEventListener("beforeunload", () => {
        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }
      });
    </script>
  </body>
</html>
