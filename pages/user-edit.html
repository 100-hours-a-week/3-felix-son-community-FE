<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ì •ë³´ ìˆ˜ì • - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="profile-edit-container">
          <h2>íšŒì›ì •ë³´ ìˆ˜ì •</h2>

          <form id="profileEditForm" class="profile-edit-form">
            <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
            <div class="profile-edit-image">
              <div
                class="profile-edit-preview"
                onclick="triggerProfileFileInput()"
              >
                <img
                  src=""
                  alt="í”„ë¡œí•„"
                  id="currentProfileImg"
                  style="display: none"
                />
                <div class="profile-edit-default" id="defaultProfileIcon">
                  <span>ğŸ‘¤</span>
                </div>
                <button type="button" class="profile-change-btn">ë³€ê²½</button>
              </div>
              <input
                type="file"
                id="profileImageInput"
                accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                style="display: none"
                onchange="handleProfileImageChange(event)"
              />
              <button
                type="button"
                class="btn-remove-image"
                id="removeImageBtn"
                style="display: none"
                onclick="removeProfileImage()"
              >
                ì´ë¯¸ì§€ ì œê±°
              </button>
            </div>

            <!-- ì´ë©”ì¼ (ì½ê¸° ì „ìš©) -->
            <div class="form-group">
              <label for="userEmail">ì´ë©”ì¼</label>
              <input type="email" id="userEmail" readonly disabled />
              <span class="helper-text">* ì´ë©”ì¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>
            </div>

            <!-- ë‹‰ë„¤ì„ -->
            <div class="form-group">
              <label for="userNickname"
                >ë‹‰ë„¤ì„ <span class="required">*</span></label
              >
              <input
                type="text"
                id="userNickname"
                required
                placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                maxlength="20"
              />
              <span class="helper-text">* 2-20ì ì´ë‚´</span>
              <span class="error-text" id="nicknameError"></span>
            </div>

            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goBack()"
              >
                ì·¨ì†Œ
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                ìˆ˜ì •í•˜ê¸°
              </button>
            </div>
          </form>

          <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
          <div class="additional-actions">
            <a href="/pages/pw-edit.html" class="btn btn-outline">
              ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
            </a>
          </div>

          <!-- íšŒì› íƒˆí‡´ -->
          <div class="account-delete-section">
            <button
              type="button"
              class="btn btn-danger btn-block"
              onclick="deleteAccount()"
            >
              íšŒì› íƒˆí‡´
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- ìˆœì„œ ì¤‘ìš”: í´ë˜ìŠ¤ ì •ì˜ â†’ ì´ˆê¸°í™” -->
    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <!-- âœ… ë§ˆì§€ë§‰ì— ì´ˆê¸°í™” -->
    <script src="/js/initService.js"></script>
    <script>
      // File ê°ì²´ ì €ì¥
      let selectedProfileImageFile = null;
      let currentBlobUrl = null; // Blob URL ê´€ë¦¬
      let originalNickname = ""; // ì›ë˜ ë‹‰ë„¤ì„ ì €ì¥
      let hasImageChanged = false; // ì´ë¯¸ì§€ ë³€ê²½ ì—¬ë¶€

      document.addEventListener("DOMContentLoaded", async () => {
        // âœ… UI ì—…ë°ì´íŠ¸
        authManager.updateUI();

        // âœ… ë¡œê·¸ì¸ í™•ì¸ ê°œì„ 
        if (!authManager.isLoggedIn()) {
          showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }

        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        await loadUserInfo();

        // âœ… ìœ íš¨ì„± ê²€ì‚¬ ì„¤ì •
        setupValidation();
      });

      // âœ… ìœ íš¨ì„± ê²€ì‚¬ ì„¤ì •
      function setupValidation() {
        const nicknameInput = document.getElementById("userNickname");

        nicknameInput.addEventListener("blur", validateNickname);
        nicknameInput.addEventListener("input", () =>
          clearFieldError(nicknameInput, "nicknameError")
        );
      }

      // âœ… í•„ë“œ ì—ëŸ¬ í‘œì‹œ
      function showFieldError(input, errorId, message) {
        input.classList.add("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = message;
        errorElement.classList.add("show");
      }

      // âœ… í•„ë“œ ì—ëŸ¬ ì œê±°
      function clearFieldError(input, errorId) {
        input.classList.remove("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = "";
        errorElement.classList.remove("show");
      }

      // âœ… ë‹‰ë„¤ì„ ìœ íš¨ì„± ê²€ì‚¬
      function validateNickname() {
        const nicknameInput = document.getElementById("userNickname");
        const nickname = nicknameInput.value.trim();

        clearFieldError(nicknameInput, "nicknameError");

        if (nickname.length === 0) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."
          );
          return false;
        }

        if (nickname.length < 2) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."
          );
          return false;
        }

        if (nickname.length > 20) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì€ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."
          );
          return false;
        }

        return true;
      }

      // âœ… ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
      async function loadUserInfo() {
        try {
          const user = await userService.getUserProfile();

          // ì´ë©”ì¼ ì„¤ì •
          document.getElementById("userEmail").value = user.email;

          // ë‹‰ë„¤ì„ ì„¤ì •
          document.getElementById("userNickname").value = user.nickname;
          originalNickname = user.nickname; // ì›ë˜ ë‹‰ë„¤ì„ ì €ì¥

          // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
          if (user.profileImageUrl) {
            const profileImg = document.getElementById("currentProfileImg");
            const defaultIcon = document.getElementById("defaultProfileIcon");
            const removeBtn = document.getElementById("removeImageBtn");

            profileImg.src = user.profileImageUrl;
            profileImg.style.display = "block";
            defaultIcon.style.display = "none";
            removeBtn.style.display = "inline-block";
          }

          console.log("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì™„ë£Œ:", {
            email: user.email,
            nickname: user.nickname,
            hasProfileImage: !!user.profileImageUrl,
          });
        } catch (error) {
          console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error);

          // âœ… 401 ì—ëŸ¬ ì²˜ë¦¬
          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } else {
            showError("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      // í”„ë¡œí•„ íŒŒì¼ ì„ íƒ íŠ¸ë¦¬ê±°
      function triggerProfileFileInput() {
        document.getElementById("profileImageInput").click();
      }

      // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½ ì²˜ë¦¬
      function handleProfileImageChange(event) {
        const file = event.target.files[0];

        if (!file) return;

        // íŒŒì¼ íƒ€ì… ê²€ì¦
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          event.target.value = ""; // ì…ë ¥ ì´ˆê¸°í™”
          return;
        }

        // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
        if (file.size > 5 * 1024 * 1024) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          event.target.value = ""; // ì…ë ¥ ì´ˆê¸°í™”
          return;
        }

        // âœ… ì´ì „ Blob URL í•´ì œ
        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }

        // File ê°ì²´ ì €ì¥
        selectedProfileImageFile = file;
        hasImageChanged = true;

        // Blob URLë¡œ ë¯¸ë¦¬ë³´ê¸°
        currentBlobUrl = URL.createObjectURL(file);

        const profileImg = document.getElementById("currentProfileImg");
        const defaultIcon = document.getElementById("defaultProfileIcon");
        const removeBtn = document.getElementById("removeImageBtn");

        profileImg.src = currentBlobUrl;
        profileImg.style.display = "block";
        defaultIcon.style.display = "none";
        removeBtn.style.display = "inline-block";

        console.log("ì´ë¯¸ì§€ ì„ íƒ:", {
          fileName: file.name,
          fileSize: `${(file.size / 1024).toFixed(2)} KB`,
          fileType: file.type,
        });
      }

      // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ì œê±°
      function removeProfileImage() {
        if (!confirm("í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        selectedProfileImageFile = null;
        hasImageChanged = true; // ë³€ê²½ ì‚¬í•­ í”Œë˜ê·¸

        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
          currentBlobUrl = null;
        }

        const profileImg = document.getElementById("currentProfileImg");
        const defaultIcon = document.getElementById("defaultProfileIcon");
        const removeBtn = document.getElementById("removeImageBtn");
        const fileInput = document.getElementById("profileImageInput");

        profileImg.src = "";
        profileImg.style.display = "none";
        defaultIcon.style.display = "block";
        removeBtn.style.display = "none";
        fileInput.value = "";

        console.log("ì´ë¯¸ì§€ ì œê±° ì™„ë£Œ");
      }

      // âœ… í¼ ì œì¶œ ì²˜ë¦¬
      document
        .getElementById("profileEditForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // ìœ íš¨ì„± ê²€ì‚¬
          if (!validateNickname()) {
            showError("ë‹‰ë„¤ì„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
          }

          const nickname = document.getElementById("userNickname").value.trim();
          const submitBtn = document.getElementById("submitBtn");

          // âœ… ë³€ê²½ì‚¬í•­ í™•ì¸
          if (nickname === originalNickname && !hasImageChanged) {
            showError("ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // âœ… ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ì œì¶œ ë°©ì§€)
          submitBtn.disabled = true;
          submitBtn.textContent = "ìˆ˜ì • ì¤‘...";

          try {
            console.log("íšŒì›ì •ë³´ ìˆ˜ì • ì‹œë„:", {
              nickname,
              hasNewImage: !!selectedProfileImageFile,
              imageChanged: hasImageChanged,
            });

            // âœ… File ê°ì²´ ì „ë‹¬
            await userService.updateUserProfile(nickname, selectedProfileImageFile);

            // âœ… ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
            const updatedUser = await userService.getUserProfile();
            authManager.setUser(updatedUser);
            authManager.updateUI(); // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸

            showSuccess("íšŒì›ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");

            // âœ… Blob URL ì •ë¦¬
            if (currentBlobUrl) {
              URL.revokeObjectURL(currentBlobUrl);
            }

            setTimeout(() => {
              window.location.href = "/posts";
            }, 1500);
          } catch (error) {
            console.error("íšŒì›ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:", error);

            // âœ… ì—ëŸ¬ ì²˜ë¦¬
            let errorMessage = "íšŒì›ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";

            if (error.status === 401) {
              errorMessage = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
            } else if (error.status === 400) {
              errorMessage = error.message || "ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
            } else if (error.message) {
              errorMessage = error.message;
            }

            showError(errorMessage);

            // âœ… ë²„íŠ¼ ë³µêµ¬
            submitBtn.disabled = false;
            submitBtn.textContent = "ìˆ˜ì •í•˜ê¸°";
          }
        });

      // âœ… íšŒì› íƒˆí‡´
      async function deleteAccount() {
        if (
          !confirm(
            "íšŒì›ì„ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ 1ì£¼ì¼ ì´ë‚´ì— ì¬ë¡œê·¸ì¸ì´ ì—†ì„ ì‹œ ê³„ì •ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤."
          )
        ) {
          return;
        }

        if (
          !confirm("ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        ) {
          return;
        }

        try {
          await userService.deleteAccount();

          showSuccess("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.");

          // âœ… Blob URL ì •ë¦¬
          if (currentBlobUrl) {
            URL.revokeObjectURL(currentBlobUrl);
          }

          // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (auth.jsì˜ logoutì´ í˜ì´ì§€ ì´ë™ ì²˜ë¦¬)
          setTimeout(() => {
            authManager.logout();
          }, 1500);
        } catch (error) {
          console.error("íšŒì› íƒˆí‡´ ì‹¤íŒ¨:", error);

          // âœ… ì—ëŸ¬ ì²˜ë¦¬
          let errorMessage = "íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";

          if (error.status === 401) {
            errorMessage = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
          } else if (error.message) {
            errorMessage = error.message;
          }

          showError(errorMessage);
        }
      }

      // âœ… ì·¨ì†Œ ë²„íŠ¼
      function goBack() {
        const nickname = document.getElementById("userNickname").value.trim();

        // ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ í™•ì¸
        if (nickname !== originalNickname || hasImageChanged) {
          if (!confirm("ë³€ê²½ëœ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
          }
        }

        // Blob URL ì •ë¦¬
        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }

        window.location.href = "/posts";
      }

      // âœ… í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ Blob URL ì •ë¦¬
      window.addEventListener("beforeunload", () => {
        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }
      });
    </script>
  </body>
</html>
