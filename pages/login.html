<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>๋ก๊ทธ์ธ - ์ปค๋ฎค๋ํฐ</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="auth-container">
          <h2>๋ก๊ทธ์ธ</h2>

          <form id="loginForm" class="auth-form">
            <div class="form-group">
              <label for="email">์ด๋ฉ์ผ</label>
              <input
                type="email"
                id="email"
                required
                placeholder="์ด๋ฉ์ผ์ ์๋ฅํ์ธ์"
              />
            </div>

            <div class="form-group">
              <label for="password">๋น๋ฐ๋ฒํธ</label>
              <input
                type="password"
                id="password"
                required
                placeholder="๋น๋ฐ๋ฒํธ๋ฅผ ์๋ฅํ์ธ์"
              />
            </div>

            <button type="submit" class="btn btn-primary btn-large">
              ๋ก๊ทธ์ธ
            </button>

            <p class="auth-link">
              ๊ณ์์ด ์์ผ์๊ฐ์? <a href="/register">ํ์๊ฐ์</a>
            </p>
          </form>
        </div>
      </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        authManager.updateUI();

        // ์ด๋ฏธ ๋ก๊ทธ์ธ๋์ด ์์ผ๋ฉด ํ์ผ๋ก ๋ฆฌ๋ค์ด๋ํธ
        if (authManager.isLoggedIn()) {
          window.location.href = "/";
          return;
        }

        setupLoginForm();
      });

      function setupLoginForm() {
        const form = document.getElementById("loginForm");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;

          if (!email || !password) {
            showError("์ด๋ฉ์ผ๊ณผ ๋น๋ฐ๋ฒํธ๋ฅผ ์๋ฅํด์ฃผ์ธ์.");
            return;
          }

          try {
            console.log("๋ก๊ทธ์ธ ์์ฒญ:", { email });

            // โ api.login() ์ง์ ํธ์ถ (accountRestored ํ์ธ์ ์ํด)
            const response = await api.login(email, password);

            console.log("๋ก๊ทธ์ธ ์ฑ๊ณต:", response);

          

            // โ ํํฐ ์์ฅ (auth.js์ setToken ์ฌ์ฉ)
            authManager.setToken(response.accessToken);

            // โ refreshToken ์์ฅ
            if (response.refreshToken) {
              localStorage.setItem("refreshToken", response.refreshToken);
            }

            // โ ์ฌ์ฉ์ ์๋ณด ์์ฅ (setUser ์ฌ์ฉ, setUserInfo ์๋!)
            const userInfo = {
              userId: response.userId,
              email: response.email,
              nickname: response.nickname,
              profileImageUrl: response.profileImageUrl,
            };
            authManager.setUser(userInfo);

            // โ UI ์๋ฐ์ดํธ
            authManager.updateUI();

            // โ ๊ณ์ ๋ณต๊ตฌ ์ ํน๋ณ ๋ฉ์์ง, ์ผ๋ฐ ๋ก๊ทธ์ธ ์ ๊ธฐ๋ณธ ๋ฉ์์ง
            if (response.accountRestored === true) {
              showSuccess(
                "๊ณ์์ด ๋ณต๊ตฌ๋์์ต๋๋ค! ๋ค์ ๋์์ค์ ๊ฒ์ ํ์ํฉ๋๋ค. ๐"
              );
            } else {
              showSuccess("๋ก๊ทธ์ธ๋์์ต๋๋ค!");
            }

            setTimeout(() => {
              window.location.href = "/";
            }, 1500);
          } catch (error) {
            console.error("๋ก๊ทธ์ธ ์คํจ:", error);
            showError(error.message || "๋ก๊ทธ์ธ์ ์คํจํ์ต๋๋ค.");
          }
        });
      }

    </script>

    
  </body>
</html>