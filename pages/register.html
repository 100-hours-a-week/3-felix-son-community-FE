<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="register-container">
          <h2>íšŒì›ê°€ì…</h2>

          <form id="registerForm" class="register-form-layout">
            <!-- ì™¼ìª½: í”„ë¡œí•„ ì‚¬ì§„ + ë‹‰ë„¤ì„ -->
            <div class="profile-section">
              <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
              <div class="profile-image-upload">
                <div
                  class="profile-image-preview"
                  id="profilePreview"
                  onclick="triggerFileInput()"
                >
                  <img
                    src=""
                    alt="í”„ë¡œí•„"
                    id="previewImg"
                    style="display: none"
                  />
                  <div class="default-profile-icon" id="defaultIcon">
                    <span>ğŸ‘¤</span>
                    <p>í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</p>
                  </div>
                </div>
                <input
                  type="file"
                  id="profileImageInput"
                  accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
              </div>

              <!-- ë‹‰ë„¤ì„ -->
              <div class="form-group">
                <label for="nickname">ë‹‰ë„¤ì„</label>
                <input
                  type="text"
                  id="nickname"
                  required
                  placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ -->
            <div class="credentials-section">
              <div class="form-group">
                <label for="email">ì´ë©”ì¼</label>
                <input
                  type="email"
                  id="email"
                  required
                  placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>

              <div class="form-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input
                  type="password"
                  id="password"
                  required
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>

              <div class="form-group">
                <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input
                  type="password"
                  id="passwordConfirm"
                  required
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
            </div>

            <!-- ê°€ì…í•˜ê¸° ë²„íŠ¼ + ë¡œê·¸ì¸ ìœ ë„ -->
            <div class="form-footer">
              <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                ê°€ì…í•˜ê¸°
              </button>
              <p class="auth-link">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login">ë¡œê·¸ì¸</a>
              </p>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
      // âœ… File ê°ì²´ ì €ì¥ (base64 ëŒ€ì‹ )
      let selectedImageFile = null;

      document.addEventListener("DOMContentLoaded", () => {
        authManager.updateUI();

        // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (authManager.isLoggedIn()) {
          window.location.href = "/";
          return;
        }

        setupRegisterForm();
      });

      // íŒŒì¼ ì…ë ¥ íŠ¸ë¦¬ê±°
      function triggerFileInput() {
        document.getElementById("profileImageInput").click();
      }

      // âœ… ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬ - File ê°ì²´ë§Œ ì €ì¥
      function handleImageSelect(event) {
        const file = event.target.files[0];

        if (!file) return;

        // íŒŒì¼ íƒ€ì… ê²€ì¦
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return;
        }

        // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
        if (file.size > 5 * 1024 * 1024) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        // âœ… File ê°ì²´ ì €ì¥
        selectedImageFile = file;

        // âœ… Blob URLë¡œ ë¯¸ë¦¬ë³´ê¸° (ë©”ëª¨ë¦¬ íš¨ìœ¨ì )
        const blobUrl = URL.createObjectURL(file);
        const previewImg = document.getElementById("previewImg");
        const defaultIcon = document.getElementById("defaultIcon");

        previewImg.src = blobUrl;
        previewImg.style.display = "block";
        defaultIcon.style.display = "none";

        console.log("ì´ë¯¸ì§€ ì„ íƒ ì™„ë£Œ:", file.name, file.size, "bytes");
      }

      // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ (FormData ì‚¬ìš©)
      async function uploadProfileImage(file) {
        const formData = new FormData();
        formData.append("images", file);

        try {
          // âœ… ë°±ì—”ë“œ ì „ì²´ URL ì‚¬ìš© (í¬íŠ¸ 8080)
          const response = await fetch("http://localhost:8080/api/images", {
            method: "POST",
            body: formData,
            // Content-Type í—¤ë”ë¥¼ ì„¤ì •í•˜ì§€ ì•ŠìŒ (ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ boundary ì„¤ì •)
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("ì„œë²„ ì‘ë‹µ:", errorText);
            throw new Error("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          const data = await response.json();
          
          // ImageUploadResponse { urls: ["http://..."] }
          if (data.urls && data.urls.length > 0) {
            console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:", data.urls[0]);
            return data.urls[0];  // ì²« ë²ˆì§¸ URL ë°˜í™˜
          }

          throw new Error("ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
          throw error;
        }
      }

      function setupRegisterForm() {
        const form = document.getElementById("registerForm");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const passwordConfirm = document.getElementById("passwordConfirm").value;
          const nickname = document.getElementById("nickname").value.trim();
          const submitBtn = document.getElementById("submitBtn");

          // ìœ íš¨ì„± ê²€ì‚¬
          if (!email || !password || !nickname) {
            showError("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          if (password !== passwordConfirm) {
            showError("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }

          if (password.length < 8) {
            showError("ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            return;
          }

          // ë²„íŠ¼ ë¹„í™œì„±í™”
          submitBtn.disabled = true;
          const originalText = submitBtn.textContent;

          try {
            let profileImageUrl = null;

            // âœ… 1ë‹¨ê³„: ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
            if (selectedImageFile) {
              submitBtn.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
              console.log("í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘");
              
              profileImageUrl = await uploadProfileImage(selectedImageFile);
              console.log("í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:", profileImageUrl);
            }

            // âœ… 2ë‹¨ê³„: íšŒì›ê°€ì… API í˜¸ì¶œ (ì§§ì€ URLë§Œ ì „ì†¡)
            submitBtn.textContent = "íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...";
            console.log("íšŒì›ê°€ì… ìš”ì²­:", {
              email,
              nickname,
              profileImageUrl,
            });

            await api.signup(email, password, nickname, profileImageUrl);

            showSuccess("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");

            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } catch (error) {
            console.error("íšŒì›ê°€ì… ì‹¤íŒ¨:", error);
            showError(error.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            
            // ë²„íŠ¼ ë³µêµ¬
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }
    </script>
  </body>
</html>