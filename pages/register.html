<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - ì»¤ë®¤ë‹ˆí‹°</title>
    <!-- âœ… CSS íŒŒì¼ ë¡œë“œ (style íƒœê·¸ ì œê±°) -->
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="register-container">
          <h2>íšŒì›ê°€ì…</h2>

          <form id="registerForm" class="register-form-layout">
            <!-- ì™¼ìª½: í”„ë¡œí•„ ì‚¬ì§„ + ë‹‰ë„¤ì„ -->
            <div class="profile-section">
              <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
              <div class="profile-image-upload">
                <div
                  class="profile-image-preview"
                  id="profilePreview"
                  role="button"
                  tabindex="0"
                  aria-label="í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ"
                >
                  <img
                    src=""
                    alt="í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°"
                    id="previewImg"
                    style="display: none"
                  />
                  <div class="default-profile-icon" id="defaultIcon">
                    <span>ğŸ‘¤</span>
                    <p>í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</p>
                    <small>(ì„ íƒì‚¬í•­)</small>
                  </div>
                </div>
                <input
                  type="file"
                  id="profileImageInput"
                  accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                  style="display: none"
                  aria-label="í”„ë¡œí•„ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ"
                />
              </div>

              <!-- ë‹‰ë„¤ì„ -->
              <div class="form-group">
                <label for="nickname">ë‹‰ë„¤ì„ <span class="required">*</span></label>
                <input
                  type="text"
                  id="nickname"
                  required
                  minlength="2"
                  maxlength="20"
                  placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (2-20ì)"
                  autocomplete="nickname"
                />
                <small class="form-hint">2-20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</small>
              </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ -->
            <div class="credentials-section">
              <div class="form-group">
                <label for="email">ì´ë©”ì¼ <span class="required">*</span></label>
                <input
                  type="email"
                  id="email"
                  required
                  placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                  autocomplete="email"
                />
              </div>

              <div class="form-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label>
                <input
                  type="password"
                  id="password"
                  required
                  minlength="8"
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (8ì ì´ìƒ)"
                  autocomplete="new-password"
                />
                <small class="form-hint">8ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”</small>
              </div>

              <div class="form-group">
                <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label>
                <input
                  type="password"
                  id="passwordConfirm"
                  required
                  minlength="8"
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                  autocomplete="new-password"
                />
              </div>
            </div>

            <!-- ê°€ì…í•˜ê¸° ë²„íŠ¼ + ë¡œê·¸ì¸ ìœ ë„ -->
            <div class="form-footer">
              <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                ê°€ì…í•˜ê¸°
              </button>
              <p class="auth-link">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login">ë¡œê·¸ì¸</a>
              </p>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
      // âœ… ì „ì—­ ë³€ìˆ˜
      let selectedImageFile = null;
      let currentBlobUrl = null; // Blob URL ì¶”ì 

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("íšŒì›ê°€ì… í˜ì´ì§€ ì´ˆê¸°í™”");

        try {
          // âœ… authManager ì´ˆê¸°í™” ëŒ€ê¸°
          await authManager.init();

          // âœ… ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          if (authManager.isLoggedIn()) {
            console.log("ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì - ë¦¬ë‹¤ì´ë ‰íŠ¸");
            window.location.href = "/";
            return;
          }

          // âœ… í¼ ì„¤ì •
          setupRegisterForm();
          setupImageUpload();

        } catch (error) {
          console.error("í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
        }
      });

      /**
       * ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¤ì •
       */
      function setupImageUpload() {
        const profilePreview = document.getElementById("profilePreview");
        const profileImageInput = document.getElementById("profileImageInput");

        // í´ë¦­ ì´ë²¤íŠ¸
        profilePreview.addEventListener("click", () => {
          profileImageInput.click();
        });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ì ‘ê·¼ì„±)
        profilePreview.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            profileImageInput.click();
          }
        });

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        profileImageInput.addEventListener("change", handleImageSelect);
      }

      /**
       * ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬
       */
      function handleImageSelect(event) {
        const file = event.target.files[0];

        if (!file) return;

        console.log("ì„ íƒëœ íŒŒì¼:", {
          name: file.name,
          size: `${(file.size / 1024).toFixed(2)} KB`,
          type: file.type
        });

        // âœ… íŒŒì¼ íƒ€ì… ê²€ì¦
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          event.target.value = ""; // ì…ë ¥ ì´ˆê¸°í™”
          return;
        }

        // âœ… íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          event.target.value = "";
          return;
        }

        // âœ… ì´ì „ Blob URL í•´ì œ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }

        // âœ… File ê°ì²´ ì €ì¥
        selectedImageFile = file;

        // âœ… Blob URLë¡œ ë¯¸ë¦¬ë³´ê¸°
        currentBlobUrl = URL.createObjectURL(file);
        const previewImg = document.getElementById("previewImg");
        const defaultIcon = document.getElementById("defaultIcon");

        previewImg.src = currentBlobUrl;
        previewImg.style.display = "block";
        defaultIcon.style.display = "none";

        console.log("ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì„¤ì • ì™„ë£Œ");
      }

      /**
       * íšŒì›ê°€ì… í¼ ì„¤ì •
       */
      function setupRegisterForm() {
        const form = document.getElementById("registerForm");
        const submitBtn = document.getElementById("submitBtn");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // âœ… ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const passwordConfirm = document.getElementById("passwordConfirm").value;
          const nickname = document.getElementById("nickname").value.trim();

          // âœ… ìœ íš¨ì„± ê²€ì‚¬
          if (!validateForm(email, password, passwordConfirm, nickname)) {
            return;
          }

          // âœ… ë²„íŠ¼ ë¹„í™œì„±í™”
          submitBtn.disabled = true;
          const originalText = submitBtn.textContent;

          try {
            let profileImageUrl = null;

            // âœ… 1ë‹¨ê³„: ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìˆëŠ” ê²½ìš°)
            if (selectedImageFile) {
              submitBtn.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
              console.log("í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘");

              try {
                // âœ… api.jsì˜ uploadImages ë©”ì„œë“œ ì‚¬ìš©
                const uploadResponse = await api.uploadImages([selectedImageFile]);
                profileImageUrl = uploadResponse.urls[0];
                
                console.log("í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:", profileImageUrl);
              } catch (uploadError) {
                console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", uploadError);
                
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ì„ íƒê¶Œ ì œê³µ
                const continueWithoutImage = confirm(
                  "í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n" +
                  "ì´ë¯¸ì§€ ì—†ì´ íšŒì›ê°€ì…ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
                );
                
                if (!continueWithoutImage) {
                  throw new Error("íšŒì›ê°€ì…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                
                profileImageUrl = null;
              }
            }

            // âœ… 2ë‹¨ê³„: íšŒì›ê°€ì… API í˜¸ì¶œ
            submitBtn.textContent = "íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...";
            console.log("íšŒì›ê°€ì… ìš”ì²­:", {
              email,
              nickname,
              profileImageUrl: profileImageUrl || "(ì—†ìŒ)",
            });

            const success = await authManager.signup(
              email,
              password,
              nickname,
              profileImageUrl
            );

            if (success) {
              console.log("íšŒì›ê°€ì… ì„±ê³µ");
              
              // âœ… Blob URL ì •ë¦¬
              if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
              }

              // ì„±ê³µ ë©”ì‹œì§€ëŠ” authManager.signup()ì—ì„œ ì´ë¯¸ í‘œì‹œë¨
              setTimeout(() => {
                window.location.href = "/login";
              }, 1500);
            } else {
              // ì‹¤íŒ¨ (ì—ëŸ¬ëŠ” authManagerì—ì„œ ì´ë¯¸ í‘œì‹œ)
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } catch (error) {
            console.error("íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
            showError(error.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

            // âœ… ë²„íŠ¼ ë³µêµ¬
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      /**
       * í¼ ìœ íš¨ì„± ê²€ì‚¬
       */
      function validateForm(email, password, passwordConfirm, nickname) {
        // í•„ìˆ˜ í•„ë“œ í™•ì¸
        if (!email || !password || !passwordConfirm || !nickname) {
          showError("ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }

        // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showError("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }

        // ë‹‰ë„¤ì„ ê¸¸ì´ ê²€ì¦
        if (nickname.length < 2 || nickname.length > 20) {
          showError("ë‹‰ë„¤ì„ì€ 2-20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }

        // ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì¦
        if (password.length < 8) {
          showError("ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return false;
        }

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê²€ì¦
        if (password !== passwordConfirm) {
          showError("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return false;
        }

        return true;
      }

      // âœ… í˜ì´ì§€ ë– ë‚  ë•Œ Blob URL ì •ë¦¬
      window.addEventListener("beforeunload", () => {
        if (currentBlobUrl) {
          URL.revokeObjectURL(currentBlobUrl);
        }
      });
    </script>
  </body>
</html>