<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="register-container">
          <!-- âœ… auth-container â†’ register-container -->
          <h2>íšŒì›ê°€ì…</h2>

          <form id="registerForm" class="register-form-layout">
            <!-- ì™¼ìª½: í”„ë¡œí•„ ì‚¬ì§„ + ë‹‰ë„¤ì„ -->
            <div class="profile-section">
              <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
              <div class="profile-image-upload">
                <div
                  class="profile-image-preview"
                  id="profilePreview"
                  onclick="triggerFileInput()"
                >
                  <img
                    src=""
                    alt="í”„ë¡œí•„"
                    id="previewImg"
                    style="display: none"
                  />
                  <div class="default-profile-icon" id="defaultIcon">
                    <span>ğŸ‘¤</span>
                    <p>í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</p>
                  </div>
                </div>
                <input
                  type="file"
                  id="profileImageInput"
                  accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
              </div>

              <!-- ë‹‰ë„¤ì„ -->
              <div class="form-group">
                <label for="nickname">ë‹‰ë„¤ì„</label>
                <input
                  type="text"
                  id="nickname"
                  required
                  placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ -->
            <div class="credentials-section">
              <div class="form-group">
                <label for="email">ì´ë©”ì¼</label>
                <input
                  type="email"
                  id="email"
                  required
                  placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>

              <div class="form-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input
                  type="password"
                  id="password"
                  required
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>

              <div class="form-group">
                <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input
                  type="password"
                  id="passwordConfirm"
                  required
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
            </div>

            <!-- ê°€ì…í•˜ê¸° ë²„íŠ¼ + ë¡œê·¸ì¸ ìœ ë„ -->
            <div class="form-footer">
              <button type="submit" class="btn btn-primary btn-large">
                ê°€ì…í•˜ê¸°
              </button>
              <p class="auth-link">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login">ë¡œê·¸ì¸</a>
              </p>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
      let selectedImageFile = null;
      let selectedImageUrl = null;

      document.addEventListener("DOMContentLoaded", () => {
        authManager.updateUI();

        // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (authManager.isLoggedIn()) {
          window.location.href = "/";
          return;
        }

        setupRegisterForm();
      });

      // íŒŒì¼ ì…ë ¥ íŠ¸ë¦¬ê±°
      function triggerFileInput() {
        document.getElementById("profileImageInput").click();
      }

      // ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬
      function handleImageSelect(event) {
        const file = event.target.files[0];

        if (!file) return;

        // íŒŒì¼ íƒ€ì… ê²€ì¦
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return;
        }

        // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
        if (file.size > 5 * 1024 * 1024) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        selectedImageFile = file;

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        const reader = new FileReader();
        reader.onload = function (e) {
          selectedImageUrl = e.target.result;

          const previewImg = document.getElementById("previewImg");
          const defaultIcon = document.getElementById("defaultIcon");

          previewImg.src = e.target.result;
          previewImg.style.display = "block";
          defaultIcon.style.display = "none";
        };
        reader.readAsDataURL(file);
      }

      function setupRegisterForm() {
        const form = document.getElementById("registerForm");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const passwordConfirm =
            document.getElementById("passwordConfirm").value;
          const nickname = document.getElementById("nickname").value.trim();

          // ìœ íš¨ì„± ê²€ì‚¬
          if (!email || !password || !nickname) {
            showError("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          if (password !== passwordConfirm) {
            showError("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }

          if (password.length < 8) {
            showError("ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            return;
          }

          try {
            console.log("íšŒì›ê°€ì… ìš”ì²­:", {
              email,
              password,
              nickname,
              profileImage: selectedImageUrl,
            });

            // íšŒì›ê°€ì… API í˜¸ì¶œ
            await api.signup(email, password, nickname, selectedImageUrl);

            showSuccess(
              "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤."
            );

            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } catch (error) {
            console.error("íšŒì›ê°€ì… ì‹¤íŒ¨:", error);
            showError(error.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        });
      }
    </script>
  </body>
</html>
