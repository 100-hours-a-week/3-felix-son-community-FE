<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="register-container">
          <h2>íšŒì›ê°€ì…</h2>

          <form id="registerForm">
            <div class="register-form-layout">
              <!-- ì™¼ìª½: í”„ë¡œí•„ ì‚¬ì§„ + ë‹‰ë„¤ì„ -->
              <div class="profile-section">
                <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
                <div class="profile-image-upload">
                  <div
                    class="profile-image-preview"
                    id="profilePreview"
                    onclick="triggerFileInput()"
                  >
                    <img
                      src=""
                      alt="í”„ë¡œí•„"
                      id="previewImg"
                      style="display: none"
                    />
                    <div class="default-profile-icon" id="defaultIcon">
                      <span>ğŸ‘¤</span>
                      <p>í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</p>
                    </div>
                  </div>
                  <button
                    type="button"
                    class="profile-remove-btn"
                    id="removeImageBtn"
                    style="display: none"
                    onclick="removeSelectedImage();"
                  >
                    Ã—
                  </button>
                  <input
                    type="file"
                    id="profileImageInput"
                    accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                    style="display: none"
                    onchange="handleImageSelect(event)"
                  />
                </div>
                <!-- âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ í—¬í¼ í…ìŠ¤íŠ¸ - ìœ„ë¡œ ì˜¬ë¦¼ -->
                <div class="form-message">
                  <span class="error-text" id="profileImageError"></span>
                </div>

                <!-- ë‹‰ë„¤ì„ -->
                <div class="form-group">
                  <label for="nickname"
                    >ë‹‰ë„¤ì„ <span class="required">*</span></label
                  >
                  <input
                    type="text"
                    id="nickname"
                    required
                    placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                  />
                  <div class="form-message">
                    <span class="helper-text"
                      >* ë„ì–´ì“°ê¸° ë¶ˆê°€ëŠ¥, 10ì ì´ë‚´</span
                    >
                    <span class="error-text" id="nicknameError"></span>
                  </div>
                </div>
              </div>

              <!-- ì˜¤ë¥¸ìª½: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ -->
              <div class="credentials-section">
                <div class="form-group">
                  <label for="email"
                    >ì´ë©”ì¼ <span class="required">*</span></label
                  >
                  <input
                    type="email"
                    id="email"
                    required
                    placeholder="example@email.com"
                  />
                  <div class="form-message">
                    <span class="error-text" id="emailError"></span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="password"
                    >ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label
                  >
                  <div class="password-input-wrapper">
                    <input
                      type="password"
                      id="password"
                      required
                      placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    />
                    <button
                      type="button"
                      class="password-toggle-btn"
                      onclick="togglePasswordVisibility('password')"
                      aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°"
                    >
                      <svg
                        class="eye-icon eye-off"
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M12.108 12.108C11.7494 12.4788 11.3226 12.7758 10.8513 12.9828C10.38 13.1898 9.87344 13.3027 9.35865 13.3154C8.84385 13.3281 8.33227 13.2402 7.85239 13.0569C7.3725 12.8735 6.93374 12.5984 6.55885 12.2472C6.18396 11.896 5.88041 11.4757 5.66486 11.0102C5.44931 10.5447 5.3261 10.0432 5.30082 9.53109C5.27555 9.01897 5.34871 8.50686 5.51614 8.02253C5.68357 7.5382 5.94187 7.08979 6.27585 6.70251M15.3075 15.3075C13.8947 16.4459 12.1457 17.0802 10.3333 17.1C4.66667 17.1 1 10 1 10C2.10551 8.06883 3.60013 6.37953 5.39167 5.02917L15.3075 15.3075ZM8.23333 3.53333C8.91882 3.34494 9.62462 3.2492 10.3333 3.25C16 3.25 19.6667 10.35 19.6667 10.35C19.0844 11.4463 18.3862 12.4783 17.5833 13.4292L8.23333 3.53333Z"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                        <path
                          d="M1 1L19.6667 19.6667"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                      <svg
                        class="eye-icon eye-on"
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        style="display: none"
                      >
                        <path
                          d="M1 10C1 10 4.66667 3.25 10.3333 3.25C16 3.25 19.6667 10 19.6667 10C19.6667 10 16 16.75 10.3333 16.75C4.66667 16.75 1 10 1 10Z"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                        <path
                          d="M10.3333 12.75C11.8061 12.75 13 11.5561 13 10.0833C13 8.61053 11.8061 7.41667 10.3333 7.41667C8.86053 7.41667 7.66667 8.61053 7.66667 10.0833C7.66667 11.5561 8.86053 12.75 10.3333 12.75Z"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </button>
                  </div>
                  <div class="form-message">
                    <span class="helper-text"
                      >* 8-20ì, ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ê° 1ê°œ ì´ìƒ</span
                    >
                    <span class="error-text" id="passwordError"></span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="passwordConfirm"
                    >ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label
                  >
                  <div class="password-input-wrapper">
                    <input
                      type="password"
                      id="passwordConfirm"
                      required
                      placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                    />
                    <button
                      type="button"
                      class="password-toggle-btn"
                      onclick="togglePasswordVisibility('passwordConfirm')"
                      aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°"
                    >
                      <svg
                        class="eye-icon eye-off"
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M12.108 12.108C11.7494 12.4788 11.3226 12.7758 10.8513 12.9828C10.38 13.1898 9.87344 13.3027 9.35865 13.3154C8.84385 13.3281 8.33227 13.2402 7.85239 13.0569C7.3725 12.8735 6.93374 12.5984 6.55885 12.2472C6.18396 11.896 5.88041 11.4757 5.66486 11.0102C5.44931 10.5447 5.3261 10.0432 5.30082 9.53109C5.27555 9.01897 5.34871 8.50686 5.51614 8.02253C5.68357 7.5382 5.94187 7.08979 6.27585 6.70251M15.3075 15.3075C13.8947 16.4459 12.1457 17.0802 10.3333 17.1C4.66667 17.1 1 10 1 10C2.10551 8.06883 3.60013 6.37953 5.39167 5.02917L15.3075 15.3075ZM8.23333 3.53333C8.91882 3.34494 9.62462 3.2492 10.3333 3.25C16 3.25 19.6667 10.35 19.6667 10.35C19.0844 11.4463 18.3862 12.4783 17.5833 13.4292L8.23333 3.53333Z"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                        <path
                          d="M1 1L19.6667 19.6667"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                      <svg
                        class="eye-icon eye-on"
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        style="display: none"
                      >
                        <path
                          d="M1 10C1 10 4.66667 3.25 10.3333 3.25C16 3.25 19.6667 10 19.6667 10C19.6667 10 16 16.75 10.3333 16.75C4.66667 16.75 1 10 1 10Z"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                        <path
                          d="M10.3333 12.75C11.8061 12.75 13 11.5561 13 10.0833C13 8.61053 11.8061 7.41667 10.3333 7.41667C8.86053 7.41667 7.66667 8.61053 7.66667 10.0833C7.66667 11.5561 8.86053 12.75 10.3333 12.75Z"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </button>
                  </div>
                  <div class="form-message">
                    <span class="error-text" id="passwordConfirmError"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- âœ… form-footerë¥¼ ê·¸ë¦¬ë“œ ë°–ìœ¼ë¡œ ì´ë™ -->
            <div class="form-footer">
              <button
                type="submit"
                class="btn btn-primary btn-large"
                id="submitBtn"
              >
                ê°€ì…í•˜ê¸°
              </button>
              <p class="auth-link">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login">ë¡œê·¸ì¸</a>
              </p>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/initService.js"></script>
    <script>
      let selectedImageFile = null;
      let blobUrl = null;

      document.addEventListener("DOMContentLoaded", () => {
        authManager.updateUI();

        if (authManager.isLoggedIn()) {
          window.location.href = "/";
          return;
        }

        setupRegisterForm();
        setupValidation();
      });

      function setupValidation() {
        const nicknameInput = document.getElementById("nickname");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const passwordConfirmInput = document.getElementById("passwordConfirm");

        nicknameInput.addEventListener("blur", validateNickname);
        emailInput.addEventListener("blur", validateEmail);
        passwordInput.addEventListener("blur", validatePassword);
        passwordConfirmInput.addEventListener("blur", validatePasswordConfirm);

        nicknameInput.addEventListener("input", () =>
          clearFieldError(nicknameInput, "nicknameError")
        );
        emailInput.addEventListener("input", () =>
          clearFieldError(emailInput, "emailError")
        );
        passwordInput.addEventListener("input", () =>
          clearFieldError(passwordInput, "passwordError")
        );
        passwordConfirmInput.addEventListener("input", () =>
          clearFieldError(passwordConfirmInput, "passwordConfirmError")
        );
      }

      function showFieldError(input, errorId, message) {
        input.classList.add("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = message;
        errorElement.classList.add("show");

        const formMessage = errorElement.closest(".form-message");
        if (formMessage) {
          const helperText = formMessage.querySelector(".helper-text");
          if (helperText) {
            helperText.style.opacity = "0";
            helperText.style.visibility = "hidden";
          }
        }
      }

      function clearFieldError(input, errorId) {
        input.classList.remove("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = "";
        errorElement.classList.remove("show");

        const formMessage = errorElement.closest(".form-message");
        if (formMessage) {
          const helperText = formMessage.querySelector(".helper-text");
          if (helperText) {
            helperText.style.opacity = "1";
            helperText.style.visibility = "visible";
          }
        }
      }

      function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.parentElement.querySelector(
          ".password-toggle-btn"
        );
        const eyeOff = button.querySelector(".eye-off");
        const eyeOn = button.querySelector(".eye-on");

        if (input.type === "password") {
          input.type = "text";
          eyeOff.style.display = "none";
          eyeOn.style.display = "block";
        } else {
          input.type = "password";
          eyeOff.style.display = "block";
          eyeOn.style.display = "none";
        }
      }

      // âœ… ë‹‰ë„¤ì„ ìœ íš¨ì„± ê²€ì‚¬
      function validateNickname() {
        const nicknameInput = document.getElementById("nickname");
        const nickname = nicknameInput.value.trim();

        clearFieldError(nicknameInput, "nicknameError");

        if (nickname.length === 0) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
          );
          return false;
        }

        if (/\s/.test(nickname)) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë„ì–´ì“°ê¸°ë¥¼ ì—†ì• ì£¼ì„¸ìš”"
          );
          return false;
        }

        if (nickname.length > 10) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì€ ìµœëŒ€ 10ìê¹Œì§€ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤"
          );
          return false;
        }

        return true;
      }

      // âœ… ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
      function validateEmail() {
        const emailInput = document.getElementById("email");
        const email = emailInput.value.trim();

        clearFieldError(emailInput, "emailError");

        if (email.length === 0) {
          showFieldError(emailInput, "emailError", "ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
          return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showFieldError(
            emailInput,
            "emailError",
            "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
          );
          return false;
        }

        return true;
      }

      // âœ… ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
      function validatePassword() {
        const passwordInput = document.getElementById("password");
        const password = passwordInput.value;

        clearFieldError(passwordInput, "passwordError");

        if (password.length === 0) {
          showFieldError(
            passwordInput,
            "passwordError",
            "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
          );
          return false;
        }

        if (password.length < 8 || password.length > 20) {
          showFieldError(
            passwordInput,
            "passwordError",
            "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, 20ì ì´í•˜ì´ë©°, ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ê°ê° ìµœì†Œ 1ê°œ í¬í•¨í•´ì•¼í•©ë‹ˆë‹¤"
          );
          return false;
        }

        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasUpperCase || !hasLowerCase || !hasNumber || !hasSpecial) {
          showFieldError(
            passwordInput,
            "passwordError",
            "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, 20ì ì´í•˜ì´ë©°, ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ê°ê° ìµœì†Œ 1ê°œ í¬í•¨í•´ì•¼í•©ë‹ˆë‹¤"
          );
          return false;
        }

        return true;
      }

      // âœ… ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ìœ íš¨ì„± ê²€ì‚¬
      function validatePasswordConfirm() {
        const passwordInput = document.getElementById("password");
        const passwordConfirmInput = document.getElementById("passwordConfirm");
        const password = passwordInput.value;
        const passwordConfirm = passwordConfirmInput.value;

        clearFieldError(passwordConfirmInput, "passwordConfirmError");

        if (passwordConfirm.length === 0) {
          return true; // ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ ì•ˆ í•¨
        }

        if (password !== passwordConfirm) {
          showFieldError(
            passwordConfirmInput,
            "passwordConfirmError",
            "ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤"
          );
          return false;
        }

        return true;
      }

      function triggerFileInput() {
        document.getElementById("profileImageInput").click();
      }

      function handleImageSelect(event) {
        const file = event.target.files[0];

        if (!file) return;

        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤");
          event.target.value = "";
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤");
          event.target.value = "";
          return;
        }

        if (blobUrl) {
          URL.revokeObjectURL(blobUrl);
        }

        selectedImageFile = file;

        blobUrl = URL.createObjectURL(file);
        const previewImg = document.getElementById("previewImg");
        const defaultIcon = document.getElementById("defaultIcon");
        const removeBtn = document.getElementById("removeImageBtn");

        previewImg.src = blobUrl;
        previewImg.style.display = "block";
        defaultIcon.style.display = "none";
        removeBtn.style.display = "inline-block";

        // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ì—ëŸ¬ ì œê±°
        const profileImageError = document.getElementById("profileImageError");
        profileImageError.textContent = "";
        profileImageError.classList.remove("show");

        console.log(
          "ì´ë¯¸ì§€ ì„ íƒ ì™„ë£Œ:",
          file.name,
          (file.size / 1024).toFixed(2),
          "KB"
        );
      }

      function removeSelectedImage() {
        selectedImageFile = null;

        if (blobUrl) {
          URL.revokeObjectURL(blobUrl);
          blobUrl = null;
        }

        const previewImg = document.getElementById("previewImg");
        const defaultIcon = document.getElementById("defaultIcon");
        const removeBtn = document.getElementById("removeImageBtn");
        const fileInput = document.getElementById("profileImageInput");

        previewImg.src = "";
        previewImg.style.display = "none";
        defaultIcon.style.display = "block";
        removeBtn.style.display = "none";
        fileInput.value = "";

        // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ ì—ëŸ¬ í‘œì‹œ
        const profileImageError = document.getElementById("profileImageError");
        profileImageError.textContent = "í”„ë¡œí•„ ì‚¬ì§„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”";
        profileImageError.classList.add("show");

        console.log("ì´ë¯¸ì§€ ì œê±° ì™„ë£Œ");
      }

      async function uploadProfileImage(file) {
        const formData = new FormData();
        formData.append("images", file);

        try {
          console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:", file.name);

          const response = await fetch(`${apiService.baseUrl}/images`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", errorData);
            throw new Error(
              errorData.message || "ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
            );
          }

          const data = await response.json();

          if (data.urls && data.urls.length > 0) {
            console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:", data.urls[0]);
            return data.urls[0];
          }

          throw new Error("ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤");
        } catch (error) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
          throw error;
        }
      }

      function setupRegisterForm() {
        const form = document.getElementById("registerForm");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // âœ… í”„ë¡œí•„ ì´ë¯¸ì§€ í•„ìˆ˜ ì²´í¬
          if (!selectedImageFile) {
            const profilePreview = document.getElementById("profilePreview");
            const profileImageError =
              document.getElementById("profileImageError");

            profilePreview.classList.add("required-highlight");
            setTimeout(() => {
              profilePreview.classList.remove("required-highlight");
            }, 500);

            profileImageError.textContent = "í”„ë¡œí•„ ì‚¬ì§„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”";
            profileImageError.classList.add("show");

            profilePreview.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
            return;
          }

          const isNicknameValid = validateNickname();
          const isEmailValid = validateEmail();
          const isPasswordValid = validatePassword();
          const isPasswordConfirmValid = validatePasswordConfirm();

          if (
            !isNicknameValid ||
            !isEmailValid ||
            !isPasswordValid ||
            !isPasswordConfirmValid
          ) {
            return;
          }

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const nickname = document.getElementById("nickname").value.trim();
          const submitBtn = document.getElementById("submitBtn");

          submitBtn.disabled = true;
          const originalText = submitBtn.textContent;

          try {
            submitBtn.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
            const profileImageUrl = await uploadProfileImage(selectedImageFile);

            submitBtn.textContent = "íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...";
            // signup í•¨ìˆ˜ê°€ ì´ë¯¸ JSON ì‘ë‹µ ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤ê³  ê°€ì •
            const responseData = await authManager.signup(
              email,
              password,
              nickname,
              profileImageUrl
            );

            // ì‘ë‹µ ê°ì²´ê°€ ì•„ë‹ˆë¯€ë¡œ ë°”ë¡œ dataì—ì„œ ì„±ê³µ ìœ ë¬´ í™•ì¸
            if (responseData.success || responseData.status === 201) {
              const successMessage =
                responseData.message ||
                "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤";
              showSuccess(successMessage);

              if (blobUrl) URL.revokeObjectURL(blobUrl);

              setTimeout(() => {
                window.location.href = "/login";
              }, 1500);
            } else {
              // ì‹¤íŒ¨ ì²˜ë¦¬: ì—ëŸ¬ ê°ì²´ë¡œ throwí•˜ê±°ë‚˜ ì§ì ‘ ì—ëŸ¬ ì²˜ë¦¬
              throw new Error(
                responseData.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
              );
            }
          } catch (error) {
            console.error("íšŒì›ê°€ì… ì‹¤íŒ¨:", error);

            // errorê°ì²´ê°€ HTTP ìƒíƒœ í”„ë¡œí¼í‹°ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸ í›„ ì²˜ë¦¬
            if (error.status === 409) {
              if (error.message && error.message.includes("ì´ë©”ì¼")) {
                showFieldError(
                  document.getElementById("email"),
                  "emailError",
                  "ì¤‘ë³µëœ ì´ë©”ì¼ì…ë‹ˆë‹¤"
                );
              } else if (error.message && error.message.includes("ë‹‰ë„¤ì„")) {
                showFieldError(
                  document.getElementById("nickname"),
                  "nicknameError",
                  "ì¤‘ë³µëœ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤"
                );
              } else {
                showError(
                  error.message || "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ ë˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤"
                );
              }
            } else if (error.status === 400) {
              let errorMessage = error.message || "ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”";
              showError(errorMessage);
            } else {
              let errorMessage = "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤";
              if (error.message) errorMessage = error.message;
              showError(errorMessage);
            }

            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      window.addEventListener("beforeunload", () => {
        if (blobUrl) {
          URL.revokeObjectURL(blobUrl);
        }
      });
    </script>
  </body>
</html>
