<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="register-container">
          <h2>íšŒì›ê°€ì…</h2>

          <form id="registerForm" class="register-form-layout">
            <!-- ì™¼ìª½: í”„ë¡œí•„ ì‚¬ì§„ + ë‹‰ë„¤ì„ -->
            <div class="profile-section">
              <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
              <div class="profile-image-upload">
                <div
                  class="profile-image-preview"
                  id="profilePreview"
                  onclick="triggerFileInput()"
                >
                  <img
                    src=""
                    alt="í”„ë¡œí•„"
                    id="previewImg"
                    style="display: none"
                  />
                  <div class="default-profile-icon" id="defaultIcon">
                    <span>ğŸ‘¤</span>
                    <p>í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</p>
                    <small>(ì„ íƒì‚¬í•­)</small>
                  </div>
                </div>
                <input
                  type="file"
                  id="profileImageInput"
                  accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
                <button
                  type="button"
                  class="btn-remove-image"
                  id="removeImageBtn"
                  style="display: none"
                  onclick="removeSelectedImage()"
                >
                  ì´ë¯¸ì§€ ì œê±°
                </button>
              </div>

              <!-- ë‹‰ë„¤ì„ -->
              <div class="form-group">
                <label for="nickname"
                  >ë‹‰ë„¤ì„ <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="nickname"
                  required
                  placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                  maxlength="20"
                />
                <span class="helper-text">* 2-20ì ì´ë‚´</span>
                <span class="error-text" id="nicknameError"></span>
              </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ -->
            <div class="credentials-section">
              <div class="form-group">
                <label for="email"
                  >ì´ë©”ì¼ <span class="required">*</span></label
                >
                <input
                  type="email"
                  id="email"
                  required
                  placeholder="example@email.com"
                />
                <span class="error-text" id="emailError"></span>
              </div>

              <div class="form-group">
                <label for="password"
                  >ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label
                >
                <input
                  type="password"
                  id="password"
                  required
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                />
                <span class="helper-text"
                  >* 8ì ì´ìƒ, ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨</span
                >
                <span class="error-text" id="passwordError"></span>
              </div>

              <div class="form-group">
                <label for="passwordConfirm"
                  >ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label
                >
                <input
                  type="password"
                  id="passwordConfirm"
                  required
                  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                />
                <span class="error-text" id="passwordConfirmError"></span>
              </div>
            </div>

            <!-- ê°€ì…í•˜ê¸° ë²„íŠ¼ + ë¡œê·¸ì¸ ìœ ë„ -->
            <div class="form-footer">
              <button
                type="submit"
                class="btn btn-primary btn-large"
                id="submitBtn"
              >
                ê°€ì…í•˜ê¸°
              </button>
              <p class="auth-link">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login">ë¡œê·¸ì¸</a>
              </p>
            </div>
          </form>
        </div>
      </div>
    </main>

    <!-- ìˆœì„œ ì¤‘ìš”: í´ë˜ìŠ¤ ì •ì˜ â†’ ì´ˆê¸°í™” -->
    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <!-- âœ… ë§ˆì§€ë§‰ì— ì´ˆê¸°í™” -->
    <script src="/js/initService.js"></script>
    <script>
      // File ê°ì²´ ì €ì¥
      let selectedImageFile = null;
      let blobUrl = null; // Blob URL ê´€ë¦¬

      document.addEventListener("DOMContentLoaded", () => {
        authManager.updateUI();

        // âœ… ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (authManager.isLoggedIn()) {
          window.location.href = "/";
          return;
        }

        setupRegisterForm();
        setupValidation();
      });

      // âœ… ìœ íš¨ì„± ê²€ì‚¬ ì„¤ì •
      function setupValidation() {
        const nicknameInput = document.getElementById("nickname");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const passwordConfirmInput = document.getElementById("passwordConfirm");

        // blur ì´ë²¤íŠ¸ë¡œ ìœ íš¨ì„± ê²€ì‚¬
        nicknameInput.addEventListener("blur", validateNickname);
        emailInput.addEventListener("blur", validateEmail);
        passwordInput.addEventListener("blur", validatePassword);
        passwordConfirmInput.addEventListener("blur", validatePasswordConfirm);

        // input ì´ë²¤íŠ¸ë¡œ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
        nicknameInput.addEventListener("input", () =>
          clearFieldError(nicknameInput, "nicknameError")
        );
        emailInput.addEventListener("input", () =>
          clearFieldError(emailInput, "emailError")
        );
        passwordInput.addEventListener("input", () =>
          clearFieldError(passwordInput, "passwordError")
        );
        passwordConfirmInput.addEventListener("input", () =>
          clearFieldError(passwordConfirmInput, "passwordConfirmError")
        );
      }

      // âœ… í•„ë“œ ì—ëŸ¬ í‘œì‹œ
      function showFieldError(input, errorId, message) {
        input.classList.add("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = message;
        errorElement.classList.add("show");
      }

      // âœ… í•„ë“œ ì—ëŸ¬ ì œê±°
      function clearFieldError(input, errorId) {
        input.classList.remove("error");
        const errorElement = document.getElementById(errorId);
        errorElement.textContent = "";
        errorElement.classList.remove("show");
      }

      // âœ… ë‹‰ë„¤ì„ ìœ íš¨ì„± ê²€ì‚¬
      function validateNickname() {
        const nicknameInput = document.getElementById("nickname");
        const nickname = nicknameInput.value.trim();

        clearFieldError(nicknameInput, "nicknameError");

        if (nickname.length === 0) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."
          );
          return false;
        }

        if (nickname.length < 2) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."
          );
          return false;
        }

        if (nickname.length > 20) {
          showFieldError(
            nicknameInput,
            "nicknameError",
            "ë‹‰ë„¤ì„ì€ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."
          );
          return false;
        }

        return true;
      }

      // âœ… ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
      function validateEmail() {
        const emailInput = document.getElementById("email");
        const email = emailInput.value.trim();

        clearFieldError(emailInput, "emailError");

        if (email.length === 0) {
          showFieldError(emailInput, "emailError", "ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showFieldError(
            emailInput,
            "emailError",
            "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤."
          );
          return false;
        }

        return true;
      }

      // âœ… ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
      function validatePassword() {
        const passwordInput = document.getElementById("password");
        const password = passwordInput.value;

        clearFieldError(passwordInput, "passwordError");

        if (password.length === 0) {
          showFieldError(
            passwordInput,
            "passwordError",
            "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
          );
          return false;
        }

        if (password.length < 8) {
          showFieldError(
            passwordInput,
            "passwordError",
            "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."
          );
          return false;
        }

        const hasLetter = /[a-zA-Z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasLetter || !hasNumber || !hasSpecial) {
          showFieldError(
            passwordInput,
            "passwordError",
            "ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤."
          );
          return false;
        }

        return true;
      }

      // âœ… ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ìœ íš¨ì„± ê²€ì‚¬
      function validatePasswordConfirm() {
        const passwordInput = document.getElementById("password");
        const passwordConfirmInput = document.getElementById("passwordConfirm");
        const password = passwordInput.value;
        const passwordConfirm = passwordConfirmInput.value;

        clearFieldError(passwordConfirmInput, "passwordConfirmError");

        if (passwordConfirm.length === 0) {
          showFieldError(
            passwordConfirmInput,
            "passwordConfirmError",
            "ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•˜ì„¸ìš”."
          );
          return false;
        }

        if (password !== passwordConfirm) {
          showFieldError(
            passwordConfirmInput,
            "passwordConfirmError",
            "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          );
          return false;
        }

        return true;
      }

      // íŒŒì¼ ì…ë ¥ íŠ¸ë¦¬ê±°
      function triggerFileInput() {
        document.getElementById("profileImageInput").click();
      }

      // âœ… ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬
      function handleImageSelect(event) {
        const file = event.target.files[0];

        if (!file) return;

        // íŒŒì¼ íƒ€ì… ê²€ì¦
        const validTypes = [
          "image/png",
          "image/jpeg",
          "image/jpg",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showError("PNG, JPG, GIF, WEBP í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          event.target.value = ""; // ì…ë ¥ ì´ˆê¸°í™”
          return;
        }

        // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
        if (file.size > 5 * 1024 * 1024) {
          showError("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          event.target.value = ""; // ì…ë ¥ ì´ˆê¸°í™”
          return;
        }

        // âœ… ì´ì „ Blob URL í•´ì œ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
        if (blobUrl) {
          URL.revokeObjectURL(blobUrl);
        }

        // File ê°ì²´ ì €ì¥
        selectedImageFile = file;

        // Blob URLë¡œ ë¯¸ë¦¬ë³´ê¸°
        blobUrl = URL.createObjectURL(file);
        const previewImg = document.getElementById("previewImg");
        const defaultIcon = document.getElementById("defaultIcon");
        const removeBtn = document.getElementById("removeImageBtn");

        previewImg.src = blobUrl;
        previewImg.style.display = "block";
        defaultIcon.style.display = "none";
        removeBtn.style.display = "inline-block";

        console.log(
          "ì´ë¯¸ì§€ ì„ íƒ ì™„ë£Œ:",
          file.name,
          (file.size / 1024).toFixed(2),
          "KB"
        );
      }

      // âœ… ì„ íƒí•œ ì´ë¯¸ì§€ ì œê±°
      function removeSelectedImage() {
        selectedImageFile = null;

        if (blobUrl) {
          URL.revokeObjectURL(blobUrl);
          blobUrl = null;
        }

        const previewImg = document.getElementById("previewImg");
        const defaultIcon = document.getElementById("defaultIcon");
        const removeBtn = document.getElementById("removeImageBtn");
        const fileInput = document.getElementById("profileImageInput");

        previewImg.src = "";
        previewImg.style.display = "none";
        defaultIcon.style.display = "block";
        removeBtn.style.display = "none";
        fileInput.value = "";

        console.log("ì´ë¯¸ì§€ ì œê±° ì™„ë£Œ");
      }

      // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì¸ì¦ ì—†ì´)
      async function uploadProfileImage(file) {
        const formData = new FormData();
        formData.append("images", file);

        try {
          console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:", file.name);

          const response = await fetch("http://localhost:8080/api/images", {
            method: "POST",
            body: formData,
            // âœ… íšŒì›ê°€ì… ì‹œì—ëŠ” í† í° ì—†ì´ ì—…ë¡œë“œ (ë°±ì—”ë“œì—ì„œ í—ˆìš©í•´ì•¼ í•¨)
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", errorData);
            throw new Error(
              errorData.message || "ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            );
          }

          const data = await response.json();

          if (data.urls && data.urls.length > 0) {
            console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:", data.urls[0]);
            return data.urls[0];
          }

          throw new Error("ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
          throw error;
        }
      }

      function setupRegisterForm() {
        const form = document.getElementById("registerForm");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // âœ… ëª¨ë“  ìœ íš¨ì„± ê²€ì‚¬ ì‹¤í–‰
          const isNicknameValid = validateNickname();
          const isEmailValid = validateEmail();
          const isPasswordValid = validatePassword();
          const isPasswordConfirmValid = validatePasswordConfirm();

          if (
            !isNicknameValid ||
            !isEmailValid ||
            !isPasswordValid ||
            !isPasswordConfirmValid
          ) {
            showError("ì…ë ¥ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
          }

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const nickname = document.getElementById("nickname").value.trim();
          const submitBtn = document.getElementById("submitBtn");

          // âœ… ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ì œì¶œ ë°©ì§€)
          submitBtn.disabled = true;
          const originalText = submitBtn.textContent;

          try {
            let profileImageUrl = null;

            // âœ… 1ë‹¨ê³„: ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë¡œë“œ
            if (selectedImageFile) {
              submitBtn.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...";
              console.log("í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘");

              profileImageUrl = await uploadProfileImage(selectedImageFile);
              console.log("í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:", profileImageUrl);
            }

            // âœ… 2ë‹¨ê³„: íšŒì›ê°€ì… API í˜¸ì¶œ
            submitBtn.textContent = "íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...";
            console.log("íšŒì›ê°€ì… ìš”ì²­:", {
              email,
              nickname,
              profileImageUrl: profileImageUrl || "ì—†ìŒ",
            });

            await authManager.signup(email, password, nickname, profileImageUrl);

            showSuccess(
              "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤."
            );

            // âœ… Blob URL ì •ë¦¬
            if (blobUrl) {
              URL.revokeObjectURL(blobUrl);
            }

            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } catch (error) {
            console.error("íšŒì›ê°€ì… ì‹¤íŒ¨:", error);

            // âœ… êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
            let errorMessage = "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";

            if (error.status === 400) {
              errorMessage = error.message || "ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
            } else if (error.status === 409) {
              errorMessage = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
            } else if (error.message) {
              errorMessage = error.message;
            }

            showError(errorMessage);

            // âœ… ë²„íŠ¼ ë³µêµ¬
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // âœ… í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ Blob URL ì •ë¦¬
      window.addEventListener("beforeunload", () => {
        if (blobUrl) {
          URL.revokeObjectURL(blobUrl);
        }
      });
    </script>
  </body>
</html>
