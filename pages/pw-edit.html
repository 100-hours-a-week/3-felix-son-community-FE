<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>비밀번호 수정 - 커뮤니티</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="profile-edit-container">
          <h2>비밀번호 수정</h2>

          <form id="passwordForm" class="profile-edit-form">
            <div class="form-group">
              <label for="password">새 비밀번호</label>
              <input
                type="password"
                id="password"
                name="password"
                placeholder="새 비밀번호를 입력하세요"
                required
              />
              <span class="helper-text"
                >* 8자 이상, 영문, 숫자, 특수문자 포함</span
              >
              <span class="error-text" id="passwordError"></span>
            </div>

            <div class="form-group">
              <label for="confirmPassword">비밀번호 확인</label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                placeholder="비밀번호를 한번 더 입력하세요"
                required
              />
              <span class="helper-text"
                >* 위와 동일한 비밀번호를 입력하세요</span
              >
              <span class="error-text" id="confirmError"></span>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="goBack()"
              >
                취소
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                수정하기
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <!-- 순서 중요: 클래스 정의 → 초기화 -->
    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <!-- ✅ 마지막에 초기화 -->
    <script src="/js/initService.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ✅ UI 업데이트
        authManager.updateUI();

        // ✅ 로그인 확인 개선
        if (!authManager.isLoggedIn()) {
          showError("로그인이 필요합니다.");
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }

        // ✅ 유효성 검사 활성화
        setupValidation();
      });

      const passwordInput = document.getElementById("password");
      const confirmInput = document.getElementById("confirmPassword");
      const passwordError = document.getElementById("passwordError");
      const confirmError = document.getElementById("confirmError");
      const form = document.getElementById("passwordForm");
      const submitBtn = document.getElementById("submitBtn");

      // ✅ 유효성 검사 설정
      function setupValidation() {
        passwordInput.addEventListener("blur", validatePassword);
        confirmInput.addEventListener("blur", validateConfirmPassword);

        // 실시간 피드백 (입력 중)
        passwordInput.addEventListener("input", () => {
          if (passwordInput.value.length > 0) {
            clearFieldError(passwordInput, passwordError);
          }
        });

        confirmInput.addEventListener("input", () => {
          if (confirmInput.value.length > 0) {
            clearFieldError(confirmInput, confirmError);
          }
        });
      }

      // ✅ 필드 에러 표시
      function showFieldError(input, errorElement, message) {
        input.classList.add("error");
        errorElement.textContent = message;
        errorElement.classList.add("show");
      }

      // ✅ 필드 에러 제거
      function clearFieldError(input, errorElement) {
        input.classList.remove("error");
        errorElement.textContent = "";
        errorElement.classList.remove("show");
      }

      // ✅ 비밀번호 유효성 검사
      function validatePassword() {
        const password = passwordInput.value;
        clearFieldError(passwordInput, passwordError);

        if (password.length === 0) {
          showFieldError(
            passwordInput,
            passwordError,
            "비밀번호를 입력하세요."
          );
          return false;
        }

        if (password.length < 8) {
          showFieldError(
            passwordInput,
            passwordError,
            "비밀번호는 최소 8자 이상이어야 합니다."
          );
          return false;
        }

        const hasLetter = /[a-zA-Z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasLetter || !hasNumber || !hasSpecial) {
          showFieldError(
            passwordInput,
            passwordError,
            "영문, 숫자, 특수문자를 모두 포함해야 합니다."
          );
          return false;
        }

        return true;
      }

      // ✅ 비밀번호 확인 유효성 검사
      function validateConfirmPassword() {
        const password = passwordInput.value;
        const confirmPassword = confirmInput.value;

        clearFieldError(confirmInput, confirmError);

        if (confirmPassword.length === 0) {
          showFieldError(
            confirmInput,
            confirmError,
            "비밀번호 확인을 입력하세요."
          );
          return false;
        }

        if (password !== confirmPassword) {
          showFieldError(
            confirmInput,
            confirmError,
            "비밀번호가 일치하지 않습니다."
          );
          return false;
        }

        return true;
      }

      // ✅ 폼 제출
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        // 모든 유효성 검사 실행
        const isPasswordValid = validatePassword();
        const isConfirmValid = validateConfirmPassword();

        if (!isPasswordValid || !isConfirmValid) {
          showError("입력 내용을 확인해주세요.");
          return;
        }

        const password = passwordInput.value;
        const confirmPassword = confirmInput.value;

        // ✅ 버튼 비활성화 (중복 제출 방지)
        submitBtn.disabled = true;
        submitBtn.textContent = "수정 중...";

        console.log("비밀번호 변경 시도:", {
          hasPassword: !!password,
          hasConfirmPassword: !!confirmPassword,
          token: authManager.getToken() ? "토큰 있음" : "토큰 없음",
        });

        try {
          await userService.changePassword(password, confirmPassword);

          console.log("비밀번호 변경 성공");
          showSuccess("비밀번호가 성공적으로 변경되었습니다!");

          // ✅ 폼 초기화
          form.reset();
          clearFieldError(passwordInput, passwordError);
          clearFieldError(confirmInput, confirmError);

          // ✅ 페이지 이동
          setTimeout(() => {
            window.location.href = "/posts";
          }, 1500);
        } catch (error) {
          console.error("비밀번호 변경 실패:", error);

          // ✅ 에러 메시지 처리
          let errorMessage = "비밀번호 변경에 실패했습니다.";

          if (error.status === 401) {
            errorMessage = "인증이 만료되었습니다.";
            showError(errorMessage);
            // api.js에서 자동으로 토큰 갱신 시도
            // 갱신 실패 시 로그아웃 처리는 api.js에서 수행
          } else if (error.status === 403) {
            errorMessage = "권한이 없습니다.";
            showError(errorMessage);
            setTimeout(() => {
              authManager.logout();
            }, 2000);
          } else if (error.status === 400) {
            // 백엔드 유효성 검사 실패
            errorMessage =
              error.message || "비밀번호 형식이 올바르지 않습니다.";
            showError(errorMessage);
          } else if (error.message) {
            errorMessage = error.message;
            showError(errorMessage);
          } else {
            showError(errorMessage);
          }
        } finally {
          // ✅ 버튼 다시 활성화
          submitBtn.disabled = false;
          submitBtn.textContent = "수정하기";
        }
      });

      // ✅ 취소 버튼
      function goBack() {
        if (passwordInput.value || confirmInput.value) {
          if (!confirm("작성 중인 내용이 있습니다. 정말 취소하시겠습니까?")) {
            return;
          }
        }
        window.location.href = "/posts";
      }
    </script>
  </body>
</html>
