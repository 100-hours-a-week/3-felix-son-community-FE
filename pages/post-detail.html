<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²Œì‹œê¸€ ìƒì„¸ - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
    <style>
      .post-detail-content img {
        max-width: 100%;
        height: auto;
        margin: 15px 0;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: block;
      }

      .post-detail-content .image-wrapper {
        position: relative;
        display: inline-block;
        margin: 10px 0;
        max-width: 100%;
      }

      .post-detail-content .image-wrapper img {
        width: 100%;
        height: auto;
        display: block;
      }

      .post-content-image {
        cursor: pointer;
        transition: transform 0.3s ease;
      }
    </style>
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div id="postDetail">
          <div class="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div id="commentSection" style="display: none">
          <div class="comment-write-section">
            <h3>ëŒ“ê¸€ ì‘ì„±</h3>
            <div class="comment-form">
              <textarea
                id="commentInput"
                placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                rows="3"
              ></textarea>
              <button class="btn btn-primary" onclick="writeComment()">
                ëŒ“ê¸€ ë“±ë¡
              </button>
            </div>
          </div>

          <div class="comments-list">
            <h3>ëŒ“ê¸€ <span id="commentCount">0</span>ê°œ</h3>
            <div id="commentsList">
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/initService.js"></script>

    <script>
      let currentPost = null;
      let commentsVisible = false;
      let editingCommentId = null;
      let currentCommentsData = []; 

      document.addEventListener("DOMContentLoaded", async () => {

        const pathParts = window.location.pathname.split("/");
        const postId = pathParts[pathParts.length - 1];

        if (!postId || postId === "posts") {
          showError("ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          window.location.href = "/posts";
          return;
        }

        try {
          const post = await postService.getPost(postId);
          currentPost = post;
          renderPostDetail(post);
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/login";
            }, 2000);
          } else {
            showError("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/posts";
            }, 2000);
          }
        }
      });

      function renderMarkdownToHtml(content) {
        if (!content) return "";

        if (content.includes("<img") || content.includes("<div")) {
          if (content.includes("image-wrapper")) {
            return content;
          }
          return content;
        }

        let html = content.replace(
          /!\[(.*?)\]\((.*?)\)/g,
          (match, alt, url) => {
            return `<img src="${url}" alt="${escapeHtml(
              alt
            )}" class="post-content-image" onerror="this.style.display='none'" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px;">`;
          }
        );

        html = html.replace(/\n/g, "<br>");

        return html;
      }

      function renderPostDetail(post) {
        const postDetail = document.getElementById("postDetail");
        const currentUser = authManager.getCurrentUser();

        const user = post.user || {};
        const stats = post.stats || {
          viewsCount: 0,
          commentCount: 0,
          likesCount: 0,
        };
        const images = post.images || [];
        const nickname = user.nickname || "ìµëª…";
        const profileImageUrl = user.profileImageUrl;

        const isAuthor =
          currentUser &&
          (currentUser.userId === user.userId ||
            currentUser.nickname === nickname);

        const renderedBody = renderMarkdownToHtml(post.body || "");

        postDetail.innerHTML = `
                <div class="post-detail-container">
                    <div class="post-detail-header">
                        <h2>${escapeHtml(post.title || "ì œëª© ì—†ìŒ")}</h2>
                        <div class="post-detail-meta">
                            <div class="post-author-info">
                                ${
                                  profileImageUrl
                                    ? `<img src="${profileImageUrl}" 
                                          alt="${escapeHtml(nickname)}" 
                                          class="author-avatar-large"
                                          onerror="this.style.display='none'">`
                                    : ""
                                }
                                <span class="author-name">${escapeHtml(
                                  nickname
                                )}</span>
                            </div>
                            <div class="post-date-info">
                                <span>ì‘ì„±: ${formatDate(post.createdAt)}</span>
                                ${
                                  post.updatedAt
                                    ? `<span>ìˆ˜ì •: ${formatDate(
                                        post.updatedAt
                                      )}</span>`
                                    : ""
                                }
                            </div>
                        </div>
                        <div class="post-detail-stats">
                            <span>ğŸ‘ï¸ ì¡°íšŒ ${stats.viewsCount}</span>
                        </div>
                    </div>
                    
                    <div class="post-detail-content">
                        ${renderedBody}
                    </div>
                    
                    <!-- ì¢‹ì•„ìš”/ëŒ“ê¸€ ë²„íŠ¼ -->
                    <div class="post-interactions">
                        <button class="btn-interaction" id="likeBtn" onclick="toggleLike()">
                            <span class="icon">â¤ï¸</span>
                            <span id="likeCount">${stats.likesCount}</span>
                        </button>
                        <button class="btn-interaction" id="commentBtn" onclick="toggleComments()">
                            <span class="icon">ğŸ’¬</span>
                            <span id="commentBtnCount">${
                              stats.commentCount
                            }</span>
                        </button>
                    </div>
                    
                    <div class="post-detail-actions">
                        ${
                          isAuthor
                            ? `
                            <div class="action-buttons-right">
                               <button class="btn btn-primary" onclick="editPost('${post.postId}')">
                                    ìˆ˜ì •
                                </button>
                                <button class="btn btn-danger" onclick="deletePost('${post.postId}')">
                                    ì‚­ì œ
                                </button>
                            </div>
                        `
                            : ""
                        }
                        
                        <div class="action-buttons-center">
                            <a href="/posts" class="btn btn-secondary">
                                ëª©ë¡ìœ¼ë¡œ
                            </a>
                        </div>
                    </div>
                </div>
            `;
      }

      async function toggleComments() {
        const commentSection = document.getElementById("commentSection");
        commentsVisible = !commentsVisible;

        if (commentsVisible) {
          commentSection.style.display = "block";
          await loadComments();
        } else {
          commentSection.style.display = "none";
        }
      }

      async function loadComments() {
        if (!currentPost) return;

        try {
          const response = await commentService.getComments(currentPost.postId);
          const comments = response.content || [];

          currentCommentsData = comments;

          renderComments(comments);

          const totalComments = response.totalElements || 0;
          document.getElementById("commentCount").textContent = totalComments;
          document.getElementById("commentBtnCount").textContent =
            totalComments;
        } catch (error) {
          console.error("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          } else {
            showError("ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      function renderComments(comments) {
        const commentsList = document.getElementById("commentsList");
        const currentUser = authManager.getCurrentUser();

        if (!comments || comments.length === 0) {
          commentsList.innerHTML =
            '<div class="no-comments">ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
          return;
        }

        commentsList.innerHTML = comments
          .map((comment) => {
            const isMyComment =
              currentUser &&
              (currentUser.userId === comment.user?.userId ||
                currentUser.nickname === comment.user?.nickname);

            const isEditing = editingCommentId === comment.commentId;

            return `
            <div class="comment-item" data-comment-id="${comment.commentId}">
                <div class="comment-header">
                    <div class="comment-author-info">
                        ${
                          comment.user?.profileImageUrl
                            ? `<img src="${
                                comment.user.profileImageUrl
                              }" alt="${escapeHtml(
                                comment.user.nickname
                              )}" class="comment-avatar" onerror="this.style.display='none'">`
                            : ""
                        }
                        <span class="comment-author">${escapeHtml(
                          comment.user?.nickname || "ìµëª…"
                        )}</span>
                        <span class="comment-date">${formatDate(
                          comment.createdAt
                        )}</span>
                    </div>
                    <div class="comment-actions">
                        ${
                          isMyComment && !isEditing
                            ? `
                                <div class="comment-buttons">
                                    <button class="btn-edit-comment" onclick="startEditComment('${
                                      comment.commentId
                                    }', \`${escapeHtml(comment.body).replace(
                                /`/g,
                                "\\`"
                              )}\`)">ìˆ˜ì •</button>
                                    <button class="btn-delete-comment" onclick="deleteComment('${
                                      comment.commentId
                                    }')">ì‚­ì œ</button>
                                </div>
                            `
                            : ""
                        }
                    </div>
                </div>
                ${
                  isEditing
                    ? `
                        <div class="comment-edit-form">
                            <textarea id="editCommentInput-${
                              comment.commentId
                            }" rows="3" class="comment-edit-textarea">${escapeHtml(
                        comment.body
                      )}</textarea>
                            <div class="comment-edit-actions">
                                <button class="btn btn-primary btn-sm" onclick="saveEditComment('${
                                  comment.commentId
                                }')">
                                    ì™„ë£Œ
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="cancelEditComment()">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    `
                    : `
                        <div class="comment-body">${escapeHtml(
                          comment.body || ""
                        )}</div>
                    `
                }
            </div>
        `;
          })
          .join("");
      }

      function startEditComment(commentId, commentBody) {
        editingCommentId = commentId;
        renderComments(currentCommentsData);
      }

      async function saveEditComment(commentId) {
        const textarea = document.getElementById(
          `editCommentInput-${commentId}`
        );
        const newContent = textarea.value.trim();

        if (!newContent) {
          showError("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        try {
          await commentService.updateComment(commentId, newContent);
          showSuccess("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

          editingCommentId = null;
          await loadComments();

          const updatedPost = await postService.getPost(currentPost.postId);
          currentPost = updatedPost;
        } catch (error) {
          console.error("ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          } else {
            showError(error.message || "ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      function cancelEditComment() {
        editingCommentId = null;
        renderComments(currentCommentsData);
      }

      async function writeComment() {
        if (!authManager.isLoggedIn()) {
          showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }

        const commentInput = document.getElementById("commentInput");
        const content = commentInput.value.trim();

        if (!content) {
          showError("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        try {
          await commentService.createComment(currentPost.postId, content);
          commentInput.value = "";
          showSuccess("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

          await loadComments();

          const updatedPost = await postService.getPost(currentPost.postId);
          currentPost = updatedPost;
        } catch (error) {
          console.error("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } else {
            showError(error.message || "ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      async function deleteComment(commentId) {
        if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
          await commentService.deleteComment(commentId);
          showSuccess("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");

          await loadComments();

          const updatedPost = await postService.getPost(currentPost.postId);
          currentPost = updatedPost;
        } catch (error) {
          console.error("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          } else {
            showError(error.message || "ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      async function toggleLike() {
        if (!authManager.isLoggedIn()) {
          showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }

        const likeBtn = document.getElementById("likeBtn");
        const likeCount = document.getElementById("likeCount");

        likeBtn.disabled = true;

        try {
          const response = await postService.likePost(currentPost.postId);

          console.log("ì¢‹ì•„ìš” API ì‘ë‹µ:", response);

          let newCount = null;

          if (response.likesCount !== undefined) {
            newCount = response.likesCount;
          } else if (
            response.stats &&
            response.stats.likesCount !== undefined
          ) {
            newCount = response.stats.likesCount;
          }

          if (newCount !== null) {
            likeCount.textContent = newCount;
          }

          likeBtn.classList.add("liked-animation");
          setTimeout(() => likeBtn.classList.remove("liked-animation"), 300);
        } catch (error) {
          console.error("ì¢‹ì•„ìš” ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          } else {
            showError("ì¢‹ì•„ìš”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } finally {
          likeBtn.disabled = false;
        }
      }

      async function editPost(id) {
        if (!authManager.isLoggedIn()) {
          showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }
        window.location.href = `/posts/write?id=${id}`;
      }

      async function deletePost(id) {
        if (!authManager.isLoggedIn()) {
          showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          setTimeout(() => {
            window.location.href = "/login";
          }, 1500);
          return;
        }

        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
          await postService.deletePost(id);
          showSuccess("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          setTimeout(() => {
            window.location.href = "/posts";
          }, 1000);
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          } else {
            showError(error.message || "ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        if (!dateString) return "";

        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return "ë°©ê¸ˆ ì „";
        if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}ì¼ ì „`;

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return `${year}-${month}-${day} ${hours}:${minutes}`;
      }
    </script>
  </body>
</html>
