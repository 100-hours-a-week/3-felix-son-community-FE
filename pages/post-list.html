<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ëª©ë¡ - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <main class="main-content">
        <div class="container">
            <div class="section-header">
                <h2>ê²Œì‹œê¸€ ëª©ë¡</h2>
                <!-- âœ… style="display: none;" ì œê±° -->
                <a href="/posts/write" class="btn btn-primary" id="writePostBtn">
                    ê¸€ì“°ê¸°
                </a>
            </div>
            
            <!-- ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ ì •ë³´ -->
            <div id="pageInfo" class="page-info"></div>
            
            <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
            <div id="postList" class="post-list">
                <!-- ê²Œì‹œê¸€ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>

            <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="loading-spinner"></div>
                <p>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <!-- ë§ˆì§€ë§‰ í˜ì´ì§€ ë©”ì‹œì§€ -->
            <div id="endMessage" class="end-message" style="display: none;">
                <p>ëª¨ë“  ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ âœ“</p>
            </div>
        </div>
    </main>

    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentPage = 0;
        let isLoading = false;
        let isLastPage = false;
        let totalElements = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            // ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
            authManager.updateUI();

            // âœ… ê¸€ì“°ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì„¤ì •
            updateWriteButton();

            // ì´ˆê¸° ê²Œì‹œê¸€ ë¡œë“œ
            await loadPosts();

            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            window.addEventListener('scroll', handleScroll);
        });

        // âœ… ê¸€ì“°ê¸° ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
        function updateWriteButton() {
            const writeBtn = document.getElementById('writePostBtn');
            if (authManager.isLoggedIn()) {
                writeBtn.style.display = 'inline-block';
            } else {
                writeBtn.style.display = 'none';
            }
        }

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function handleScroll() {
            // ì´ë¯¸ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë§ˆì§€ë§‰ í˜ì´ì§€ë©´ ì¤‘ë‹¨
            if (isLoading || isLastPage) return;

            // í˜ì´ì§€ í•˜ë‹¨ ê·¼ì²˜ ë„ë‹¬ í™•ì¸ (í•˜ë‹¨ 100px ì´ë‚´)
            const scrollPosition = window.innerHeight + window.scrollY;
            const pageHeight = document.documentElement.scrollHeight;

            if (scrollPosition >= pageHeight - 100) {
                loadPosts();
            }
        }

        // ê²Œì‹œê¸€ ë¡œë“œ í•¨ìˆ˜
        async function loadPosts() {
            // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
            if (isLoading || isLastPage) return;

            try {
                isLoading = true;
                showLoadingIndicator();

                const response = await api.getPosts(currentPage, 10);
                
                // ì²« ë¡œë“œ ì‹œ ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ í‘œì‹œ
                if (currentPage === 0) {
                    totalElements = response.totalElements;
                    displayPageInfo(response);
                }

                const posts = response.content;

                // ê²Œì‹œê¸€ì´ ì—†ëŠ” ê²½ìš° (ì²« í˜ì´ì§€)
                if (currentPage === 0 && posts.length === 0) {
                    const postList = document.getElementById('postList');
                    postList.innerHTML = '<div class="no-posts">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    hideLoadingIndicator();
                    isLastPage = true;
                    return;
                }

                // ê²Œì‹œê¸€ ë Œë”ë§ (ê¸°ì¡´ ëª©ë¡ì— ì¶”ê°€)
                appendPosts(posts);

                // ë§ˆì§€ë§‰ í˜ì´ì§€ ì²´í¬
                if (response.last) {
                    isLastPage = true;
                    showEndMessage();
                } else {
                    currentPage++; // ë‹¤ìŒ í˜ì´ì§€ ì¤€ë¹„
                }

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                
                if (currentPage === 0) {
                    const postList = document.getElementById('postList');
                    postList.innerHTML = '<div class="error-message">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                }
            } finally {
                isLoading = false;
                hideLoadingIndicator();
            }
        }

        // ê²Œì‹œê¸€ì„ ëª©ë¡ì— ì¶”ê°€
        function appendPosts(posts) {
            const postList = document.getElementById('postList');
            
            const postsHTML = posts.map(post => {
                // ì•ˆì „í•˜ê²Œ user ë°ì´í„° ì ‘ê·¼
                const user = post.user || {};
                const nickname = user.nickname || 'ìµëª…';
                const profileImageUrl = user.profileImageUrl;
                const stats = post.stats || { viewsCount: 0, commentCount: 0, likesCount: 0 };
                
                return `
                    <article class="post-card" onclick="location.href='/posts/${post.postId}'">
                        <div class="post-header">
                            <div class="post-author-info">
                                ${profileImageUrl ? 
                                    `<img src="${profileImageUrl}" 
                                          alt="${escapeHtml(nickname)}" 
                                          class="author-avatar-small"
                                          onerror="this.style.display='none'">` 
                                    : '<div class="author-avatar-small default-avatar">ğŸ‘¤</div>'}
                                <span class="author-nickname">${escapeHtml(nickname)}</span>
                            </div>
                            <span class="post-date">${formatDate(post.createdAt)}</span>
                        </div>
                        <h3>${escapeHtml(post.title || 'ì œëª© ì—†ìŒ')}</h3>
                        <p class="post-preview">
                            ${escapeHtml(getPreview(post.body))}
                        </p>
                        <div class="post-stats">
                            <span>ğŸ‘ï¸ ${stats.viewsCount}</span>
                            <span>ğŸ’¬ ${stats.commentCount}</span>
                            <span>â¤ï¸ ${stats.likesCount}</span>
                        </div>
                    </article>
                `;
            }).join('');

            // ì²« í˜ì´ì§€ë©´ êµì²´, ì•„ë‹ˆë©´ ì¶”ê°€
            if (currentPage === 0) {
                postList.innerHTML = postsHTML;
            } else {
                postList.insertAdjacentHTML('beforeend', postsHTML);
            }
        }

        // ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ í‘œì‹œ
        function displayPageInfo(response) {
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.innerHTML = `
                <span>ì „ì²´ ê²Œì‹œê¸€: ${response.totalElements}ê°œ</span>
            `;
        }

        // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = 'block';
        }

        // ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = 'none';
        }

        // ë§ˆì§€ë§‰ í˜ì´ì§€ ë©”ì‹œì§€ í‘œì‹œ
        function showEndMessage() {
            const endMessage = document.getElementById('endMessage');
            endMessage.style.display = 'block';
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getPreview(content, maxLength = 150) {
            if (!content) return '';
            return content.length > maxLength 
                ? content.substring(0, maxLength) + '...' 
                : content;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            // 1ë¶„ ë¯¸ë§Œ
            if (diff < 60000) {
                return 'ë°©ê¸ˆ ì „';
            }
            // 1ì‹œê°„ ë¯¸ë§Œ
            if (diff < 3600000) {
                return `${Math.floor(diff / 60000)}ë¶„ ì „`;
            }
            // 1ì¼ ë¯¸ë§Œ
            if (diff < 86400000) {
                return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
            }
            // 7ì¼ ë¯¸ë§Œ
            if (diff < 604800000) {
                return `${Math.floor(diff / 86400000)}ì¼ ì „`;
            }

            // ê·¸ ì´ìƒì€ ë‚ ì§œ í‘œì‹œ
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
</html>