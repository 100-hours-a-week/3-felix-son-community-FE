<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²Œì‹œê¸€ ëª©ë¡ - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
  </head>
  <body>
    <main class="main-content">
      <div class="container">
        <div class="section-header">
          <h2>ê²Œì‹œê¸€ ëª©ë¡</h2>
          <a href="/posts/write" class="btn btn-primary" id="writePostBtn">
            ê¸€ì“°ê¸°
          </a>
        </div>
        <div id="pageInfo" class="page-info"></div>
        <div id="postList" class="post-list">
        </div>

        <div
          id="loadingIndicator"
          class="loading-indicator"
          style="display: none"
        >
          <div class="loading-spinner"></div>
          <p>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <div id="endMessage" class="end-message" style="display: none">
          <p>ëª¨ë“  ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ âœ“</p>
        </div>
      </div>
    </main>

    <script src="/js/notificationService.js"></script>
    <script src="/js/apiService.js"></script>
    <script src="/js/postService.js"></script>
    <script src="/js/commentService.js"></script>
    <script src="/js/fileUploadService.js"></script>
    <script src="/js/userService.js"></script>
    <script src="/js/authUiManager.js"></script>
    <script src="/js/authManager.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/initService.js"></script>
    <script>
      let currentPage = 0;
      let isLoading = false;
      let isLastPage = false;
      let totalElements = 0;

      document.addEventListener("DOMContentLoaded", async () => {
       
        updateWriteButton();

        await loadPosts();

        window.addEventListener("scroll", handleScroll);
      });

      function updateWriteButton() {
        const writeBtn = document.getElementById("writePostBtn");
        if (authManager.isLoggedIn()) {
          writeBtn.style.display = "inline-block";
          writeBtn.onclick = (e) => {
            if (!authManager.isLoggedIn()) {
              e.preventDefault();
              showError("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
              setTimeout(() => {
                window.location.href = "/login";
              }, 1500);
            }
          };
        } else {
          writeBtn.style.display = "none";
        }
      }

      function handleScroll() {
        if (isLoading || isLastPage) return;

        const scrollPosition = window.innerHeight + window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;

        if (scrollPosition >= pageHeight - 100) {
          loadPosts();
        }
      }

      async function loadPosts() {
        if (isLoading || isLastPage) return;

        try {
          isLoading = true;
          showLoadingIndicator();

          const response = await postService.getPosts(currentPage, 10);

          if (currentPage === 0) {
            totalElements = response.totalElements;
            displayPageInfo(response);
          }

          const posts = response.content;

          if (currentPage === 0 && posts.length === 0) {
            const postList = document.getElementById("postList");
            postList.innerHTML =
              '<div class="no-posts">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            hideLoadingIndicator();
            isLastPage = true;
            return;
          }

          appendPosts(posts);

          if (response.last) {
            isLastPage = true;
            showEndMessage();
          } else {
            currentPage++;
          }
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:", error);

          if (error.status === 401) {
            console.log("í† í° ë§Œë£Œ - ê°±ì‹  ì‹œë„ ì¤‘...");
          } else if (currentPage === 0) {
            const postList = document.getElementById("postList");
            postList.innerHTML = `
                        <div class="error-message">
                            <p>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                            <button class="btn btn-primary" onclick="retryLoadPosts()">
                                ë‹¤ì‹œ ì‹œë„
                            </button>
                        </div>
                    `;
          } else {
            showError("ê²Œì‹œê¸€ì„ ë” ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } finally {
          isLoading = false;
          hideLoadingIndicator();
        }
      }

      async function retryLoadPosts() {
        currentPage = 0;
        isLastPage = false;
        await loadPosts();
      }

      function appendPosts(posts) {
        const postList = document.getElementById("postList");

        const postsHTML = posts
          .map((post) => {
            const user = post.user || {};
            const nickname = user.nickname || "ìµëª…";
            const profileImageUrl = user.profileImageUrl;
            const stats = post.stats || {
              viewsCount: 0,
              commentCount: 0,
              likesCount: 0,
            };

            return `
                    <article class="post-card" onclick="goToPost('${
                      post.postId
                    }')">
                        <div class="post-header">
                            <div class="post-author-info">
                                ${
                                  profileImageUrl
                                    ? `<img src="${profileImageUrl}" 
                                          alt="${escapeHtml(nickname)}" 
                                          class="author-avatar-small"
                                          onerror="this.style.display='none'">`
                                    : '<div class="author-avatar-small default-avatar">ğŸ‘¤</div>'
                                }
                                <span class="author-nickname">${escapeHtml(
                                  nickname
                                )}</span>
                            </div>
                            <span class="post-date">${formatDate(
                              post.createdAt
                            )}</span>
                        </div>
                        <h3>${escapeHtml(post.title || "ì œëª© ì—†ìŒ")}</h3>
                        <p class="post-preview">
                            ${escapeHtml(getPreview(post.body))}
                        </p>
                        <div class="post-stats">
                            <span>ğŸ‘ï¸ ${stats.viewsCount}</span>
                            <span>ğŸ’¬ ${stats.commentCount}</span>
                            <span>â¤ï¸ ${stats.likesCount}</span>
                        </div>
                    </article>
                `;
          })
          .join("");

        if (currentPage === 0) {
          postList.innerHTML = postsHTML;
        } else {
          postList.insertAdjacentHTML("beforeend", postsHTML);
        }
      }

      function goToPost(postId) {
        window.location.href = `/posts/${postId}`;
      }

      function displayPageInfo(response) {
        const pageInfo = document.getElementById("pageInfo");
        pageInfo.innerHTML = `
                <span>ì „ì²´ ê²Œì‹œê¸€: ${response.totalElements}ê°œ</span>
            `;
      }

      function showLoadingIndicator() {
        const indicator = document.getElementById("loadingIndicator");
        indicator.style.display = "block";
      }

      function hideLoadingIndicator() {
        const indicator = document.getElementById("loadingIndicator");
        indicator.style.display = "none";
      }

      function showEndMessage() {
        const endMessage = document.getElementById("endMessage");
        endMessage.style.display = "block";
      }

      function getPreview(content, maxLength = 150) {
        if (!content) return "";

        let text = content.replace(/<[^>]*>/g, "");
        text = text.replace(/!\[.*?\]\(.*?\)/g, "");
        text = text.trim();

        return text.length > maxLength
          ? text.substring(0, maxLength) + "..."
          : text;
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        if (!dateString) return "";

        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) {
          return "ë°©ê¸ˆ ì „";
        }
        if (diff < 3600000) {
          return `${Math.floor(diff / 60000)}ë¶„ ì „`;
        }
        if (diff < 86400000) {
          return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
        }
        if (diff < 604800000) {
          return `${Math.floor(diff / 86400000)}ì¼ ì „`;
        }

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }
    </script>
  </body>
</html>
