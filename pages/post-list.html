<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ëª©ë¡ - ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages.css" />
</head>
<body>
    <main class="main-content">
        <div class="container">
            <div class="section-header">
                <h2>ê²Œì‹œê¸€ ëª©ë¡</h2>
                <!-- âœ… ë‹¨ìˆœ ë§í¬, JavaScript ì—†ìŒ -->
                <a href="/posts/write" class="btn btn-primary" id="writePostBtn" style="display: none;">
                    ê¸€ì“°ê¸°
                </a>
            </div>
            
            <div id="pageInfo" class="page-info"></div>
            <div id="postList" class="post-list"></div>

            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="loading-spinner"></div>
                <p>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <div id="endMessage" class="end-message" style="display: none;">
                <p>ëª¨ë“  ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ âœ“</p>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        let currentPage = 0;
        let isLoading = false;
        let isLastPage = false;
        let totalElements = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("ê²Œì‹œê¸€ ëª©ë¡ í˜ì´ì§€ ì´ˆê¸°í™”");

            try {
                await authManager.init();
                
                console.log("ë¡œê·¸ì¸ ìƒíƒœ:", authManager.isLoggedIn());

                // âœ… ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ê¸€ì“°ê¸° ë²„íŠ¼ í‘œì‹œ
                updateWriteButton();
                
                await loadPosts();
                window.addEventListener('scroll', handleScroll);
                
            } catch (error) {
                console.error("í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
            }
        });

        function updateWriteButton() {
            const writeBtn = document.getElementById('writePostBtn');
            
            if (!writeBtn) {
                console.error("writePostBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const isLoggedIn = authManager.isLoggedIn();
            console.log("ê¸€ì“°ê¸° ë²„íŠ¼ ì—…ë°ì´íŠ¸:", isLoggedIn ? "í‘œì‹œ" : "ìˆ¨ê¹€");
            
            if (isLoggedIn) {
                writeBtn.style.display = 'inline-block';
            } else {
                writeBtn.style.display = 'none';
            }
        }

        function handleScroll() {
            if (isLoading || isLastPage) return;

            const scrollPosition = window.innerHeight + window.scrollY;
            const pageHeight = document.documentElement.scrollHeight;

            if (scrollPosition >= pageHeight - 100) {
                loadPosts();
            }
        }

        async function loadPosts() {
            if (isLoading || isLastPage) return;

            try {
                isLoading = true;
                showLoadingIndicator();

                const response = await api.getPosts(currentPage, 10);
                
                if (currentPage === 0) {
                    totalElements = response.totalElements;
                    displayPageInfo(response);
                }

                const posts = response.content;

                if (currentPage === 0 && posts.length === 0) {
                    const postList = document.getElementById('postList');
                    postList.innerHTML = '<div class="no-posts">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    hideLoadingIndicator();
                    isLastPage = true;
                    return;
                }

                appendPosts(posts);

                if (response.last) {
                    isLastPage = true;
                    showEndMessage();
                } else {
                    currentPage++;
                }

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                
                if (currentPage === 0) {
                    const postList = document.getElementById('postList');
                    postList.innerHTML = '<div class="error-message">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                }
            } finally {
                isLoading = false;
                hideLoadingIndicator();
            }
        }

        function appendPosts(posts) {
            const postList = document.getElementById('postList');
            
            const postsHTML = posts.map(post => {
                const user = post.user || {};
                const nickname = user.nickname || 'ìµëª…';
                const profileImageUrl = user.profileImageUrl;
                const stats = post.stats || { viewsCount: 0, commentCount: 0, likesCount: 0 };
                
                return `
                    <article class="post-card" onclick="location.href='/posts/${post.postId}'">
                        <div class="post-header">
                            <div class="post-author-info">
                                ${profileImageUrl ? 
                                    `<img src="${escapeHtml(profileImageUrl)}" 
                                          alt="${escapeHtml(nickname)}" 
                                          class="author-avatar-small"
                                          onerror="this.style.display='none'">` 
                                    : '<div class="author-avatar-small default-avatar">ğŸ‘¤</div>'}
                                <span class="author-nickname">${escapeHtml(nickname)}</span>
                            </div>
                            <span class="post-date">${formatDate(post.createdAt)}</span>
                        </div>
                        <h3>${escapeHtml(post.title || 'ì œëª© ì—†ìŒ')}</h3>
                        <p class="post-preview">
                            ${escapeHtml(getPreview(post.body))}
                        </p>
                        <div class="post-stats">
                            <span>ğŸ‘ï¸ ${stats.viewsCount}</span>
                            <span>ğŸ’¬ ${stats.commentCount}</span>
                            <span>â¤ï¸ ${stats.likesCount}</span>
                        </div>
                    </article>
                `;
            }).join('');

            if (currentPage === 0) {
                postList.innerHTML = postsHTML;
            } else {
                postList.insertAdjacentHTML('beforeend', postsHTML);
            }
        }

        function displayPageInfo(response) {
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.innerHTML = `
                <span>ì „ì²´ ê²Œì‹œê¸€: ${response.totalElements}ê°œ</span>
            `;
        }

        function showLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = 'block';
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = 'none';
        }

        function showEndMessage() {
            const endMessage = document.getElementById('endMessage');
            endMessage.style.display = 'block';
        }

        function getPreview(content, maxLength = 150) {
            if (!content) return '';
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const text = tempDiv.textContent || tempDiv.innerText || '';
            
            return text.length > maxLength 
                ? text.substring(0, maxLength) + '...' 
                : text;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}ì¼ ì „`;

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
</html>